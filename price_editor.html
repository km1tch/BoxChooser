<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Box Price Editor</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.4/css/select.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/print.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            width: 95%;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 20px;
        }
        .dataTables_wrapper {
            margin-top: 20px;
        }
        .editable {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .editable:hover {
            background-color: #e9ecef;
        }
        .section-header {
            background-color: #343a40;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
        }
        .blue-row {
            background-color: #cfe2f3 !important;
        }
        .yellow-row {
            background-color: #fff2cc !important;
        }
        .green-row {
            background-color: #d9ead3 !important;
        }
        .pink-row {
            background-color: #f4cccc !important;
        }
        .orange-row {
            background-color: #fce5cd !important;
        }
        .normal-row {
            background-color: rgba(135, 206, 250, 0.3) !important; /* Sky Blue */
        }
        .custom-row {
            background-color: rgba(221, 160, 221, 0.3) !important; /* Plum */
        }
        
        /* Print button styles */
        .print-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        
        .print-button:hover {
            background-color: #45a049;
        }
        
        /* Column-based color scheme */
        
        /* Box price column - Light blue */
        td:nth-child(4) {
            background-color: rgba(173, 216, 230, 0.3) !important; /* Light Blue */
        }
        
        /* Standard group columns - Green hues */
        .standard-group {
            background-color: rgba(144, 238, 144, 0.3) !important; /* Light Green */
        }
        
        /* Fragile group columns - Gold/Yellow hues */
        .fragile-group {
            background-color: rgba(255, 215, 0, 0.3) !important; /* Gold */
        }
        
        /* Custom group columns - Pink/Red hues */
        .custom-group {
            background-color: rgba(255, 182, 193, 0.3) !important; /* Light Pink */
        }
        
        /* Location column - Light gray */
        td:nth-last-child(2) {
            background-color: rgba(211, 211, 211, 0.3) !important; /* Light Gray */
        }
        
        /* Actions column - Very light gray */
        td:last-child {
            background-color: rgba(245, 245, 245, 0.3) !important; /* White Smoke */
        }
        
        /* Row specific colors - add a slight tint to show row grouping */
        .blue-row td {
            box-shadow: inset 0 0 0 1000px rgba(135, 206, 250, 0.1) !important; /* Sky Blue tint */
        }
        
        .yellow-row td {
            box-shadow: inset 0 0 0 1000px rgba(255, 255, 224, 0.1) !important; /* Light Yellow tint */
        }
        
        .green-row td {
            box-shadow: inset 0 0 0 1000px rgba(152, 251, 152, 0.1) !important; /* Pale Green tint */
        }
        
        .pink-row td {
            box-shadow: inset 0 0 0 1000px rgba(255, 182, 193, 0.1) !important; /* Light Pink tint */
        }
        
        .orange-row td {
            box-shadow: inset 0 0 0 1000px rgba(255, 160, 122, 0.1) !important; /* Light Salmon tint */
        }
        
        .normal-row td {
            box-shadow: inset 0 0 0 1000px rgba(135, 206, 250, 0.1) !important; /* Sky Blue tint */
        }
        
        .custom-row td {
            box-shadow: inset 0 0 0 1000px rgba(221, 160, 221, 0.1) !important; /* Plum tint */
        }
        .changes-pending {
            background-color: #ffe0e0;
        }
        .buttons-container {
            margin: 20px 0;
        }
        .save-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .save-button:hover {
            background-color: #218838;
        }
        .save-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            background-color: #cce5ff;
            color: #004085;
        }
        
        /* Remove up/down arrows (spinners) from number inputs */
        input[type="number"] {
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Chrome, Safari, Edge, Opera */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .total-cell {
            font-weight: bold;
            color: #495057;
            cursor: not-allowed;
            border-left: 1px solid rgba(0, 0, 0, 0.2) !important;
            border-right: 1px solid rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Total cell specific colors - more saturated versions of column colors */
        .standard-group.total-cell {
            background-color: rgba(144, 238, 144, 0.6) !important; /* Light Green */
            font-weight: bold;
        }
        .fragile-group.total-cell {
            background-color: rgba(255, 215, 0, 0.6) !important; /* Gold */
            font-weight: bold;
        }
        .custom-group.total-cell {
            background-color: rgba(255, 182, 193, 0.6) !important; /* Light Pink */
            font-weight: bold;
        }
        
        /* Fix table header padding for icons */
        th {
            padding: 5px 3px !important;
            text-align: center !important;
            vertical-align: middle !important;
        }
        
        /* Center images in headers and add pointer cursor for tooltips */
        th img {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
            cursor: help;
        }
        
        /* Group header styles need to ensure icons display correctly */
        .group-header {
            padding-bottom: 0 !important;
        }
        .group-header {
            background-color: #e9ecef;
            text-align: center;
            font-weight: bold;
        }
        /* Header group colors - more saturated */
        th.standard-group {
            background-color: rgba(60, 179, 113, 0.6) !important; /* Medium Sea Green */
            border-bottom: 1px solid rgba(0, 100, 0, 0.5);
            color: white;
        }
        th.fragile-group {
            background-color: rgba(218, 165, 32, 0.6) !important; /* Goldenrod */
            border-bottom: 1px solid rgba(184, 134, 11, 0.5);
            color: white;
        }
        th.custom-group {
            background-color: rgba(205, 92, 92, 0.6) !important; /* Indian Red */
            border-bottom: 1px solid rgba(139, 0, 0, 0.5);
            color: white;
        }
        table#priceTable .undo-btn {
            opacity: 0;
            cursor: pointer;
            color: #6c757d;
            font-size: 16px;
            transition: opacity 0.2s;
            text-align: center;
        }
        table#priceTable .undo-btn:hover {
            color: #dc3545;
        }
        table#priceTable .undo-btn.show-undo {
            opacity: 1 !important;
        }
        /* Remove all icon styles from here - now in icons.css */
        
        /* Ensure tooltips work on header images */
        th img {
            cursor: help;
        }
        
        /* Print-specific styles */
        @media print {
            /* Remove all potential hiding */
            table.dataTable thead th {
                display: table-cell !important;
                visibility: visible !important;
            }
            
            /* Force ALL icons to be visible */
            table.dataTable thead th img {
                display: inline-block !important;
                visibility: visible !important;
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Override any inherited hiding */
            .custom-group {
                display: table-cell !important;
                visibility: visible !important;
            }
            
            .custom-group img {
                display: inline-block !important;
                visibility: visible !important;
            }
            /* Hide interactive UI elements */
            .buttons-container,
            .status-message,
            #backLink,
            #editInstructions,
            #readOnlyMessage,
            .undo-btn,
            .dataTables_length,
            .dataTables_filter,
            .dataTables_info,
            .dataTables_paginate {
                display: none !important;
            }
            
            /* Hide the entire header section */
            .header {
                display: none !important;
            }
            
            /* Make table full width */
            table.dataTable {
                width: 100% !important;
                page-break-inside: auto;
                font-size: 10pt;
            }
            
            /* Compact table spacing for portrait mode */
            table.dataTable th,
            table.dataTable td {
                padding: 3px 5px !important;
                font-size: 9pt;
            }
            
            /* Make headers smaller */
            table.dataTable th {
                font-size: 8pt;
                font-weight: bold;
            }
            
            /* Section headers smaller */
            .section-header {
                font-size: 11pt !important;
                padding: 4px 8px !important;
            }
            
            /* Keep table rows together */
            table.dataTable tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Hide Location and Actions columns - only those with rowspan="2" */
            /* First row: only headers that have rowspan="2" AND are last two */
            table.dataTable thead tr:first-child th[rowspan="2"]:nth-last-child(1),
            table.dataTable thead tr:first-child th[rowspan="2"]:nth-last-child(2) {
                display: none !important;
            }
            
            /* No need to hide anything in second row - the icon cells are all valid */
            
            /* Data cells */
            table.dataTable tbody tr td:last-child,
            table.dataTable tbody tr td:nth-last-child(2) {
                display: none !important;
            }
            
            /* Hide DataTables sorting arrows and indicators */
            table.dataTable thead .sorting::before,
            table.dataTable thead .sorting::after,
            table.dataTable thead .sorting_asc::before,
            table.dataTable thead .sorting_asc::after,
            table.dataTable thead .sorting_desc::before,
            table.dataTable thead .sorting_desc::after,
            table.dataTable thead .sorting_asc_disabled::before,
            table.dataTable thead .sorting_asc_disabled::after,
            table.dataTable thead .sorting_desc_disabled::before,
            table.dataTable thead .sorting_desc_disabled::after {
                display: none !important;
                content: none !important;
            }
            
            /* Remove sorting classes entirely to prevent any styling */
            table.dataTable thead th.sorting,
            table.dataTable thead th.sorting_asc,
            table.dataTable thead th.sorting_desc {
                background-image: none !important;
                cursor: default !important;
                position: relative !important;
            }
            
            /* DataTables 1.11 specific */
            table.dataTable thead th.sorting:before,
            table.dataTable thead th.sorting:after,
            table.dataTable thead th.sorting_asc:before,
            table.dataTable thead th.sorting_asc:after,
            table.dataTable thead th.sorting_desc:before,
            table.dataTable thead th.sorting_desc:after {
                display: none !important;
                content: "" !important;
            }
            
            /* Ensure colors are preserved */
            * {
                color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Adjust body margins for print */
            body {
                margin: 0.4in;
                font-size: 11pt;
            }
            
            /* Ensure section headers stay with their tables */
            .section-header {
                page-break-after: avoid;
            }
            
            /* Keep icons visible in print */
            th img {
                width: 14px !important;
                height: 14px !important;
                display: inline-block !important;
                visibility: visible !important;
            }
            
            /* Ensure all header images and cells are visible by default */
            table.dataTable thead tr th {
                display: table-cell !important;
            }
            
            table.dataTable thead tr th img {
                display: inline-block !important;
                visibility: visible !important;
            }
            
            /* For the second row specifically, ensure all icons are visible */
            table.dataTable thead tr:nth-child(2) th {
                display: table-cell !important;
            }
            
            table.dataTable thead tr:nth-child(2) th img {
                display: inline-block !important;
                visibility: visible !important;
                width: 14px !important;
                height: 14px !important;
            }
            
            /* Adjust group headers for better spacing */
            .group-header {
                font-size: 9pt !important;
                padding: 3px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="storeHeader">Box Price Editor</h1>
            <p id="editInstructions">Click on any price cell to edit. Your changes will be tracked and can be saved to the YAML file.</p>
            <div id="readOnlyMessage" style="display: none; padding: 10px; background-color: #ffe0e0; margin-bottom: 15px; border-radius: 4px;">
                <strong>Read-only Mode:</strong> This store is not editable. To enable editing, set 'editable: true' in the store's YAML file.
            </div>
            <div id="backLink"></div>
        </div>
        
        <div class="buttons-container">
            <button id="saveChanges" class="save-button" disabled>Save Changes</button>
            <span id="changeCount">No changes pending</span>
            <button id="printView" class="print-button">Print View</button>
        </div>
        
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <table id="priceTable" class="display responsive nowrap" style="width:100%">
            <thead id="priceTableHeader">
                <!-- Header will be built dynamically based on pricing mode -->
            </thead>
            <tbody>
                <!-- Data will be loaded dynamically -->
            </tbody>
        </table>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="/pricing.js"></script>
    <script src="/api.js"></script>
    <script>
    $(document).ready(function() {
        // Extract store number from URL and create the back link
        const pathParts = window.location.pathname.split('/');
        const storeId = pathParts[1] || '1';
        $('#backLink').html(`<a href="/${storeId}">Back to Store ${storeId} Main Page</a>`);
        $('#storeHeader').text(`Box Price Editor - Store ${storeId}`);
        
        // Store all changes to be saved
        let changedData = {};
        let changeCount = 0;
        let isEditable = false; // Default to read-only
        let pricingMode = 'standard'; // Default pricing mode
        let priceTable;
        let originalData = []; // Store original data for undo functionality

        // Generate a simple CSRF token for this session
        const csrfToken = Math.random().toString(36).substring(2, 15) +
                         Math.random().toString(36).substring(2, 15);

        
        // Function to update the change counter
        function updateChangeCounter() {
            const $saveButton = $('#saveChanges');
            const $changeCount = $('#changeCount');
            
            if (changeCount > 0) {
                $saveButton.prop('disabled', !isEditable);
                $changeCount.text(changeCount + ' change' + (changeCount > 1 ? 's' : '') + ' pending');
                $changeCount.addClass('changes-pending');
            } else {
                $saveButton.prop('disabled', true);
                $changeCount.text('No changes pending');
                $changeCount.removeClass('changes-pending');
            }
        }
        
        // Function to show status message
        function showStatus(message, type) {
            const $status = $('#statusMessage');
            $status.removeClass('success error loading').addClass(type);
            $status.text(message);
            $status.show();

            if (type !== 'loading') {
                setTimeout(function() {
                    $status.fadeOut();
                }, 5000);
            }
        }
        
        // We've moved this check to be combined with pricing mode check
        
        // First check pricing mode and editability using api.js functions
        window.api.fetchPricingMode(storeId)
            .then(mode => {
                pricingMode = mode;
                
                // Next check if store is editable
                return window.api.isStoreEditable(storeId);
            })
            .then(editable => {
                isEditable = editable;
                        
                        // Update UI based on editability
                        if (!isEditable) {
                            $('#readOnlyMessage').show();
                            $('#editInstructions').hide();
                            $('#saveChanges').prop('disabled', true);
                        }
                        
                        // Load box data next
                loadBoxData();
            })
            .catch(error => {
                console.error('Error checking pricing mode or editability:', error);
                showStatus('Failed to check store settings', 'error');
                // Still load the data even if checks fail
                loadBoxData();
            });
        
        // Function to load box data
        function loadBoxData() {
            window.api.fetchAllBoxes(storeId)
                .then(response => {
                    // Process the boxes into the format needed for the table
                    const processedData = processBoxesData(response.boxes, response.pricing_mode);
                    initializeDataTable(processedData);
                })
                .catch(error => {
                    console.error('Error loading box data:', error);
                    showStatus('Failed to load box data', 'error');
                });
        }
        
        // Function to process boxes data into table format
        function processBoxesData(boxes, mode) {
            const result = [];
            
            for (const box of boxes) {
                const model = box.model || '';
                const dimensions = box.dimensions.join('x');
                const section = getBoxSection(model, box.type);
                
                let boxData;
                
                if (mode === 'standard') {
                    const prices = box.prices || [0, 0, 0, 0];
                    boxData = {
                        section: section,
                        model: model,
                        dimensions: dimensions,
                        box_price: prices[0],
                        standard: prices[1],
                        fragile: prices[2],
                        custom: prices[3],
                        location: box.location || '???',
                        pricing_mode: 'standard'
                    };
                } else { // itemized pricing mode
                    const ip = box['itemized-prices'] || {};
                    const boxPrice = ip['box-price'] || 0;
                    
                    // Standard level
                    const standardMaterials = ip['standard-materials'] || 0;
                    const standardServices = ip['standard-services'] || 0;
                    const standardTotal = boxPrice + standardMaterials + standardServices;
                    
                    // Fragile level
                    const fragileMaterials = ip['fragile-materials'] || 0;
                    const fragileServices = ip['fragile-services'] || 0;
                    const fragileTotal = boxPrice + fragileMaterials + fragileServices;
                    
                    // Custom level
                    const customMaterials = ip['custom-materials'] || 0;
                    const customServices = ip['custom-services'] || 0;
                    const customTotal = boxPrice + customMaterials + customServices;
                    
                    boxData = {
                        section: section,
                        model: model,
                        dimensions: dimensions,
                        box_price: boxPrice,
                        standard_materials: standardMaterials,
                        standard_services: standardServices,
                        standard_total: standardTotal,
                        fragile_materials: fragileMaterials,
                        fragile_services: fragileServices,
                        fragile_total: fragileTotal,
                        custom_materials: customMaterials,
                        custom_services: customServices,
                        custom_total: customTotal,
                        location: box.location || '???',
                        pricing_mode: 'itemized'
                    };
                }
                
                result.push(boxData);
            }
            
            // Sort by section and then by model
            result.sort((a, b) => {
                if (a.section !== b.section) {
                    return a.section.localeCompare(b.section);
                }
                return a.model.localeCompare(b.model);
            });
            
            return result;
        }
        
        // Function to determine box section based on model or box type
        function getBoxSection(model, boxType) {
            // First try to categorize based on model if it exists
            if (model && model !== '') {
                if (/C-UPS$|C$|Cube$/.test(model)) {
                    return "CUBE";
                } else if (/X 4|X 3|X 6|J-11|J-14|J-15|J-16|SHIRTB/.test(model)) {
                    return "FLAT & SMALL";
                } else if (/J-20|WREATH|ST-6|MIR-3|MIR-8/.test(model)) {
                    return "MEDIUM";
                } else if (/J-64|SUITCASE|VCR|24 X 18 X 18/.test(model)) {
                    return "LARGE";
                } else {
                    return "SPECIALTY";
                }
            }
            
            // If no model or couldn't categorize, use box type
            if (boxType) {
                if (boxType === 'NormalBox') {
                    return "NORMAL";
                } else if (boxType === 'CustomBox') {
                    return "CUSTOM";
                }
            }
            
            // Fallback
            return "OTHER";
        }
        
        // Function to initialize the DataTable
        function initializeDataTable(data) {
            // First, check if a DataTable already exists and destroy it
            if (priceTable) {
                priceTable.destroy();
            }
            
            // Clear the table header completely
            const $tableHeader = $('#priceTableHeader');
            $tableHeader.empty();
            
            // Determine if model and location columns should be shown
            const firstItem = data[0] || {};
            
            // Check if models are auto-generated from dimensions or actually present in the data
            const hasRealModels = data.some(item => {
                // If model starts with "Unknown-" it's likely auto-generated
                return item.model && item.model !== '' && !item.model.startsWith('Unknown-');
            });
            
            const hasLocations = data.some(item => item.location && item.location !== '???');
            
            // Base columns - section and dimensions always shown
            const columns = [
                { data: 'section' },
                { data: 'dimensions' }
            ];
            
            // Conditionally add model column only if real (non-auto-generated) models exist
            if (hasRealModels) {
                columns.splice(1, 0, { data: 'model' });
            }
            
            // Add appropriate header structure based on pricing mode
            if (pricingMode === 'standard') {
                // Standard pricing mode: simple header
                const headerRow = $('<tr></tr>');
                
                // Add basic columns
                headerRow.append('<th>Section</th>');
                if (hasRealModels) {
                    headerRow.append('<th>Model</th>');
                }
                headerRow.append('<th>Dimensions</th>');
                headerRow.append('<th>Box Price</th>');
                headerRow.append('<th><img src="/assets/icons/total.png" width="24" height="24" alt="Standard Total" title="Standard Total"></th>');
                headerRow.append('<th><img src="/assets/icons/total.png" width="24" height="24" alt="Fragile Total" title="Fragile Total"></th>');
                headerRow.append('<th><img src="/assets/icons/total.png" width="24" height="24" alt="Custom Total" title="Custom Total"></th>');
                if (hasLocations) {
                    headerRow.append('<th>Location</th>');
                }
                headerRow.append('<th>Actions</th>');
                
                $tableHeader.append(headerRow);
                
                columns.push(
                    { 
                        data: 'box_price',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable'
                    },
                    { 
                        data: 'standard',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable'
                    },
                    { 
                        data: 'fragile',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable'
                    },
                    { 
                        data: 'custom',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable'
                    }
                );
            } else {
                // Itemized pricing mode: complex header with groups
                
                // First row with group headers
                const groupHeaderRow = $('<tr></tr>');
                
                // Common columns (span 2 rows)
                groupHeaderRow.append('<th rowspan="2">Section</th>');
                if (hasRealModels) {
                    groupHeaderRow.append('<th rowspan="2">Model</th>');
                }
                groupHeaderRow.append('<th rowspan="2">Dimensions</th>');
                groupHeaderRow.append('<th rowspan="2">Box Price</th>');
                
                // Add group headers for each packing level
                groupHeaderRow.append('<th colspan="3" class="group-header standard-group">Standard Packing</th>');
                groupHeaderRow.append('<th colspan="3" class="group-header fragile-group">Fragile Packing</th>');
                groupHeaderRow.append('<th colspan="3" class="group-header custom-group">Custom Packing</th>');
                
                // Common columns at the end
                if (hasLocations) {
                    groupHeaderRow.append('<th rowspan="2">Location</th>');
                }
                groupHeaderRow.append('<th rowspan="2">Actions</th>');
                
                // Second row with individual column headers
                const detailHeaderRow = $('<tr></tr>');
                
                // Standard group columns  
                detailHeaderRow.append('<th class="standard-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Standard Materials"></th>');
                detailHeaderRow.append('<th class="standard-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Standard Services"></th>');
                detailHeaderRow.append('<th class="standard-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Standard Total"></th>');
                
                // Fragile group columns
                detailHeaderRow.append('<th class="fragile-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Fragile Materials"></th>');
                detailHeaderRow.append('<th class="fragile-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Fragile Services"></th>');
                detailHeaderRow.append('<th class="fragile-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Fragile Total"></th>');
                
                // Custom group columns
                detailHeaderRow.append('<th class="custom-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Custom Materials"></th>');
                detailHeaderRow.append('<th class="custom-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Custom Services"></th>');
                detailHeaderRow.append('<th class="custom-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Custom Total"></th>');
                
                // Add both rows to the header
                $tableHeader.append(groupHeaderRow);
                $tableHeader.append(detailHeaderRow);
                
                columns.push(
                    { 
                        data: 'box_price',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable'
                    },
                    // Standard level
                    { 
                        data: 'standard_materials',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable standard-group'
                    },
                    { 
                        data: 'standard_services',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable standard-group'
                    },
                    { 
                        data: 'standard_total',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'total-cell standard-group'
                    },
                    // Fragile level
                    { 
                        data: 'fragile_materials',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable fragile-group'
                    },
                    { 
                        data: 'fragile_services',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable fragile-group'
                    },
                    { 
                        data: 'fragile_total',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'total-cell fragile-group'
                    },
                    // Custom level
                    { 
                        data: 'custom_materials',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable custom-group'
                    },
                    { 
                        data: 'custom_services',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'editable custom-group'
                    },
                    { 
                        data: 'custom_total',
                        render: function(data) {
                            return parseFloat(data).toFixed(2);
                        },
                        className: 'total-cell custom-group'
                    }
                );
            }
            
            // Add location column conditionally
            if (hasLocations) {
                columns.push({ data: 'location' });
            }
            
            // Always add actions column
            columns.push({
                data: null,
                render: function(data, type, row) {
                    const hasChanges = changedData[row.model] !== undefined;
                    const classes = hasChanges ? 'undo-btn show-undo' : 'undo-btn';
                    return '<span class="' + classes + '">↺</span>';
                },
                className: 'text-center',
                orderable: false
            });
            
            // Store a deep copy of the original data for undo functionality
            originalData = JSON.parse(JSON.stringify(data));
            
            // Initialize the DataTable with the appropriate columns
            priceTable = $('#priceTable').DataTable({
                data: data,
                columns: columns,
                paging: false,
                responsive: true,
                rowCallback: function(row, data) {
                    // Apply classes based on section
                    if (data.section === 'CUBE') {
                        $(row).addClass('blue-row');
                    } else if (data.section === 'FLAT & SMALL') {
                        $(row).addClass('yellow-row');
                    } else if (data.section === 'MEDIUM') {
                        $(row).addClass('green-row');
                    } else if (data.section === 'LARGE') {
                        $(row).addClass('pink-row');
                    } else if (data.section === 'SPECIALTY') {
                        $(row).addClass('orange-row');
                    } else if (data.section === 'NORMAL') {
                        $(row).addClass('normal-row');
                    } else if (data.section === 'CUSTOM') {
                        $(row).addClass('custom-row');
                    }
                }
            });
            
            setupEventHandlers();
        }
        
        // Set up all event handlers
        function setupEventHandlers() {
            // Make price cells editable only if the store is editable
            // Handle undo button click
            $('#priceTable').on('click', '.undo-btn.show-undo', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const $button = $(this);
                const $tr = $button.closest('tr');
                
                
                if (!$tr.length) {
                    console.error('Could not find parent tr');
                    return;
                }
                
                try {
                    const row = priceTable.row($tr);
                    
                    if (!row || typeof row.data !== 'function') {
                        console.error('Could not get valid DataTable row');
                        return;
                    }
                    
                    const rowData = row.data();
                
                if (!rowData) {
                    console.error('Row data is undefined');
                    return;
                }
                
                
                // Remove changes for this row
                if (changedData[rowData.model]) {
                    delete changedData[rowData.model];
                    changeCount--;
                    
                    
                    // Reload original data for this row
                    const originalRow = originalData.find(r => r.model === rowData.model);
                    if (originalRow) {
                        // Restore all original values based on pricing mode
                        if (pricingMode === 'standard') {
                            rowData.box_price = originalRow.box_price;
                            rowData.standard = originalRow.standard;
                            rowData.fragile = originalRow.fragile;
                            rowData.custom = originalRow.custom;
                        } else {
                            // For itemized pricing, restore all fields
                            rowData.box_price = originalRow.box_price;
                            rowData.standard_materials = originalRow.standard_materials;
                            rowData.standard_services = originalRow.standard_services;
                            rowData.standard_total = originalRow.standard_total;
                            rowData.fragile_materials = originalRow.fragile_materials;
                            rowData.fragile_services = originalRow.fragile_services;
                            rowData.fragile_total = originalRow.fragile_total;
                            rowData.custom_materials = originalRow.custom_materials;
                            rowData.custom_services = originalRow.custom_services;
                            rowData.custom_total = originalRow.custom_total;
                        }
                        
                        // Update the row data and redraw
                        row.data(rowData).draw();
                    }
                    
                    updateChangeCounter();
                }
                } catch (error) {
                    console.error('Error in undo handler:', error);
                }
            });
            
            $('#priceTable').on('click', 'td.editable', function() {
                // Skip if store is not editable
                if (!isEditable) {
                    showStatus('This store is read-only. Set editable: true in the YAML file to enable editing.', 'error');
                    return;
                }
                
                const cell = $(this);
                const value = cell.text();
                const row = priceTable.row(cell.closest('tr')).data();
                const columnIndex = priceTable.cell(this).index().column;
                const header = priceTable.column(columnIndex).header();
                let columnName = header.textContent.toLowerCase().trim();
                // If no text content, check for img alt text
                if (!columnName) {
                    const img = header.querySelector('img');
                    if (img) {
                        columnName = img.alt.toLowerCase().trim();
                    }
                }
                
                // Create input for editing - safer approach to avoid XSS
                cell.empty();
                const input = $('<input>', {
                    type: 'number',
                    step: '0.01',
                    min: '0',
                    placeholder: 'Enter price',
                    pattern: '[0-9]+(\.[0-9]{1,2})?', // Restrict to valid price format
                    style: 'width: 100%; box-sizing: border-box; text-align: right; padding-right: 5px;'
                });
                input.val(value);
                cell.append(input);
                input.focus();
                input.select();
                
                // Handle keyboard navigation
                input.on('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        
                        // Find next editable cell
                        const allEditableCells = $('#priceTable td.editable');
                        const currentIndex = allEditableCells.index(cell);
                        let nextCell;
                        
                        if (e.shiftKey) {
                            // Shift+Tab goes left
                            nextCell = allEditableCells.eq(currentIndex - 1);
                        } else {
                            // Tab goes right
                            nextCell = allEditableCells.eq(currentIndex + 1);
                        }
                        
                        // If we found a next cell, trigger blur then click it
                        if (nextCell.length) {
                            $(this).blur();
                            setTimeout(() => {
                                nextCell.click();
                            }, 10);
                        } else {
                            // No next cell, just blur
                            $(this).blur();
                        }
                    } else if (e.key === 'Enter') {
                        // Enter just completes the edit
                        e.preventDefault();
                        $(this).blur();
                    } else if (e.key === 'Escape') {
                        // Escape cancels edit
                        $(this).val(value); // Restore original value
                        $(this).blur();
                    }
                });
                
                // Handle input blur (save value)
                input.on('blur', function() {
                    const inputValue = $(this).val();
                    const newValue = parseFloat(inputValue);
                    const originalValue = parseFloat(value);
                    
                    // Check if value is valid (must be a valid number)
                    if (isNaN(newValue) || inputValue.trim() === '' || /[^0-9.\-]/.test(inputValue)) {
                        // Simply revert to the original value without marking as changed
                        cell.text(value); // Use the original string value to maintain exact formatting
                        showStatus('Invalid input', 'error');
                        return;
                    }
                    
                    // Check if the value actually changed
                    if (newValue === originalValue) {
                        // No actual change, just revert to original value
                        cell.text(value); // Use the original string value to maintain exact formatting
                        return;
                    }
                    
                    // Valid number that has changed
                    cell.text(newValue.toFixed(2));
                    
                    // Track the change
                    if (!changedData[row.model]) {
                        changedData[row.model] = {};
                        changeCount++;
                        
                        // Show the undo button for this row
                        const rowElement = cell.closest('tr');
                        const rowIndex = priceTable.row(rowElement).index();
                        const rowData = priceTable.row(rowIndex).data();
                        
                        // Mark row as having changes in the data
                        priceTable.row(rowIndex).data(rowData);
                        
                        // Force redraw the row to update the undo button
                        priceTable.row(rowIndex).invalidate().draw(false);
                    }
                    
                    if (pricingMode === 'standard') {
                        // Determine which price field to update for standard pricing
                        let priceIndex;
                        switch(columnName) {
                            case 'box price': priceIndex = 0; break;
                            case 'standard': priceIndex = 1; break;
                            case 'fragile': priceIndex = 2; break;
                            case 'custom': priceIndex = 3; break;
                            default: return; // Exit if column not recognized
                        }
                        
                        if (priceIndex !== undefined) {
                            changedData[row.model][priceIndex] = newValue;
                        }
                    } else {
                        // For itemized pricing, we store the actual field name
                        let fieldName;
                        let packingLevel = '';
                        
                        switch(columnName) {
                            case 'box price': 
                                fieldName = 'box-price'; 
                                packingLevel = 'all'; // Box price affects all totals
                                break;
                            case 'materials': 
                                if (columnIndex === 4) {
                                    fieldName = 'standard-materials';
                                    packingLevel = 'standard';
                                }
                                else if (columnIndex === 7) {
                                    fieldName = 'fragile-materials';
                                    packingLevel = 'fragile';
                                }
                                else if (columnIndex === 10) {
                                    fieldName = 'custom-materials';
                                    packingLevel = 'custom';
                                }
                                break;
                            case 'services': 
                                if (columnIndex === 5) {
                                    fieldName = 'standard-services';
                                    packingLevel = 'standard';
                                }
                                else if (columnIndex === 8) {
                                    fieldName = 'fragile-services';
                                    packingLevel = 'fragile';
                                }
                                else if (columnIndex === 11) {
                                    fieldName = 'custom-services';
                                    packingLevel = 'custom';
                                }
                                break;
                        }
                        
                        if (fieldName) {
                            changedData[row.model][fieldName] = newValue;
                            
                            // Find this row in the table
                            const rowElement = cell.closest('tr');
                            const rowIndex = priceTable.row(rowElement).index();
                            
                            // Get the current box price
                            let boxPrice = parseFloat(priceTable.cell(rowIndex, 3).data());
                            
                            // Update cell data with new value
                            priceTable.cell(cell).data(newValue);
                            
                            // If box price changed, update it directly
                            if (fieldName === 'box-price') {
                                boxPrice = newValue;
                            }
                            
                            // Update totals based on which field changed
                            if (packingLevel === 'all' || packingLevel === 'standard') {
                                // Update standard total
                                const stdMaterials = parseFloat(priceTable.cell(rowIndex, 4).data());
                                const stdServices = parseFloat(priceTable.cell(rowIndex, 5).data());
                                const stdTotal = boxPrice + stdMaterials + stdServices;
                                
                                // Update the total cell
                                priceTable.cell(rowIndex, 6).data(parseFloat(stdTotal).toFixed(2));
                            }
                            
                            if (packingLevel === 'all' || packingLevel === 'fragile') {
                                // Update fragile total
                                const fragMaterials = parseFloat(priceTable.cell(rowIndex, 7).data());
                                const fragServices = parseFloat(priceTable.cell(rowIndex, 8).data());
                                const fragTotal = boxPrice + fragMaterials + fragServices;
                                
                                // Update the total cell
                                priceTable.cell(rowIndex, 9).data(parseFloat(fragTotal).toFixed(2));
                            }
                            
                            if (packingLevel === 'all' || packingLevel === 'custom') {
                                // Update custom total
                                const custMaterials = parseFloat(priceTable.cell(rowIndex, 10).data());
                                const custServices = parseFloat(priceTable.cell(rowIndex, 11).data());
                                const custTotal = boxPrice + custMaterials + custServices;
                                
                                // Update the total cell
                                priceTable.cell(rowIndex, 12).data(parseFloat(custTotal).toFixed(2));
                            }
                            
                            // Redraw the row to show updated values
                            priceTable.row(rowIndex).invalidate().draw(false);
                        }
                    }
                    
                    updateChangeCounter();
                });
                
                // Handle enter key
                input.on('keypress', function(e) {
                    if (e.which === 13) {
                        input.blur();
                    }
                });
                
                // Handle input events to validate values and prevent NaN
                input.on('input', function() {
                    const inputValue = $(this).val();
                });
                
                // Validate input on change
                input.on('change', function() {
                    const inputValue = $(this).val();
                    // If empty or invalid, do not modify the input - blur handler will handle reverting
                    if (inputValue === '' || isNaN(parseFloat(inputValue)) || /[^0-9.\-]/.test(inputValue)) {
                        // Don't change the input - let blur handle reverting
                    }
                });
            });
            
            // Save changes button handler
            $('#saveChanges').on('click', function() {
                // Double-check editability before saving
                if (!isEditable) {
                    showStatus('This store is read-only. Set editable: true in the YAML file to enable editing.', 'error');
                    return;
                }
                
                if (changeCount > 0) {
                    showStatus('Saving changes...', 'loading');
                    
                    
                    // Use the appropriate update function based on pricing mode
                    const updateFunction = pricingMode === 'standard' 
                        ? window.api.updateStandardPrices
                        : window.api.updateItemizedPrices;
                    
                    updateFunction(storeId, changedData, csrfToken)
                        .then(() => {
                            showStatus('All changes saved successfully!', 'success');
                            changedData = {};
                            changeCount = 0;
                            updateChangeCounter();
                            
                            // Force DataTables to re-render all cells and redraw  
                            priceTable.rows().invalidate().draw();
                        })
                        .catch(error => {
                            console.error('Error saving changes:', error);
                            showStatus('Error saving changes: ' + error.message, 'error');
                        });
                }
            });
            
            // Print view button handler
            $('#printView').on('click', function() {
                // Just trigger the browser's print dialog for this page
                window.print();
            });
        }
    });
    </script>
</body>
</html>