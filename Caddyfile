:80 {
	# Enable compression
	encode gzip

	# Security headers
	header {
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# API routes - proxy to FastAPI backend (must come before file_server)
	handle /api/* {
		reverse_proxy backend:8000
	}

	# Health check for backend
	handle /health {
		reverse_proxy backend:8000
	}

	# Serve static files
	root * /srv/frontend

	# JavaScript files with proper MIME type
	handle /js/*.js {
		header Content-Type "application/javascript"
		header Cache-Control "public, max-age=3600"
		file_server
	}

	# CSS files
	handle /assets/css/*.css {
		header Content-Type "text/css"
		header Cache-Control "public, max-age=3600"
		file_server
	}

	# Favicon
	handle /favicon.ico {
		rewrite * /assets/favicon.ico
		file_server
	}

	# Cache static assets
	handle /assets/* {
		header Cache-Control "public, max-age=31536000"
		file_server
	}

	# Handle specific routes
	handle /login {
		rewrite * /login.html
		file_server
	}

	# Store-specific routes with named pages
	@store_pages {
		path_regexp store ^/(\d+)/(wizard|prices|floorplan|import|settings)$
	}
	handle @store_pages {
		rewrite * /{http.regexp.store.2}.html
		file_server
	}

	# Store root pages (e.g., /1, /2, etc.)
	@store_root {
		path_regexp ^/\d+/?$
	}
	handle @store_root {
		rewrite * /index.html
		file_server
	}

	# Root redirect
	handle / {
		rewrite * /index.html
		file_server
	}

	# Default file server for everything else
	handle {
		file_server
	}
}