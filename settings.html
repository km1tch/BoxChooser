<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Settings</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/assets/css/common.css" />
    <style>
      .rules-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Tab styles */
      .tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        border: 2px solid transparent;
        border-bottom: none;
        background: #f5f5f5;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        font-weight: 500;
      }

      .tab:hover {
        background: #e0e0e0;
      }

      .tab.active {
        background: white;
        border-color: #ddd;
        border-bottom: 2px solid white;
        margin-bottom: -2px;
        color: #2196f3;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .rules-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #ddd;
      }

      .rules-grid {
        display: grid;
        gap: 15px;
      }

      .rule-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: #fff;
        transition: all 0.2s;
      }

      .rule-card.custom {
        border-color: #4caf50;
        background-color: #f1f8f4;
      }

      .rule-card.default {
        border-color: #999;
        background-color: #f9f9f9;
      }

      .rule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .rule-title {
        font-size: 18px;
        font-weight: bold;
      }

      .rule-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      .badge-custom {
        background: #4caf50;
        color: white;
      }

      .badge-default {
        background: #999;
        color: white;
      }

      .rule-details {
        display: grid;
        gap: 10px;
      }

      .rule-field {
        display: flex;
        gap: 10px;
      }

      .field-label {
        font-weight: bold;
        min-width: 120px;
      }

      .field-value {
        flex: 1;
      }

      .instructions-preview {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
        max-height: 100px;
        overflow-y: auto;
      }

      .rule-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #2196f3;
        color: white;
      }

      .btn-primary:hover {
        background: #1976d2;
      }

      .btn-secondary {
        background: #757575;
        color: white;
      }

      .btn-secondary:hover {
        background: #616161;
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-danger:hover {
        background: #d32f2f;
      }

      /* Info icon styles */
      .info-icon {
        color: #2196f3;
        margin-left: 8px;
        cursor: pointer;
        font-size: 16px;
        vertical-align: middle;
        transition: color 0.2s;
      }

      .info-icon:hover {
        color: #1976d2;
        transform: scale(1.1);
      }

      /* Threshold info modal styles */
      .threshold-info-modal {
        max-width: 1000px !important;
        width: 90% !important;
      }

      .threshold-info-content {
        line-height: 1.6;
      }

      .threshold-example {
        background: #f5f5f5;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 4px;
      }

      .threshold-example h4 {
        margin-top: 0;
        color: #2196f3;
      }

      .threshold-example code {
        background: #e0e0e0;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 14px;
      }

      .visual-example {
        display: flex;
        gap: 20px;
        margin: 15px 0;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .box-visual {
        text-align: center;
        padding: 15px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 4px;
        min-width: 140px;
        flex: 0 0 auto;
      }

      .box-visual.highlighted {
        border-color: #4caf50;
        background: #f1f8f4;
      }

      /* Engine config styles */
      .engine-section {
        margin-bottom: 30px;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
      }

      .engine-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
      }

      /* Three-segment slider styles */
      .three-segment-slider {
        position: relative;
        height: 60px;
        margin: 20px 0;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 10px;
      }

      .slider-track {
        position: relative;
        height: 30px;
        background: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        cursor: pointer;
      }

      .slider-segment {
        position: absolute;
        height: 100%;
        transition: none;
      }

      .segment-price {
        background: #2196f3;
        left: 0;
      }

      .segment-efficiency {
        background: #4caf50;
      }

      .segment-ease {
        background: #ff9800;
        right: 0;
      }

      .slider-handle {
        position: absolute;
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid #333;
        border-radius: 50%;
        top: 3px;
        cursor: grab;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: none;
      }

      .slider-handle:active {
        cursor: grabbing;
        transform: scale(1.1);
      }

      .slider-handle.dragging {
        cursor: grabbing;
        transform: scale(1.1);
      }

      .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        padding: 0 10px;
      }

      .slider-label {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
      }

      .label-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
      }

      .label-value {
        font-weight: bold;
        min-width: 40px;
        text-align: right;
      }

      .strategy-grid {
        display: grid;
        gap: 15px;
      }

      .strategy-control {
        display: grid;
        grid-template-columns: 180px 300px 30px;
        align-items: center;
        gap: 15px;
      }

      .strategy-value {
        font-weight: bold;
        text-align: center;
        padding: 5px 8px;
        background: #f5f5f5;
        border-radius: 4px;
        min-width: 30px;
        margin-left: 2em;
      }

      .threshold-controls {
        display: grid;
        gap: 15px;
      }

      .threshold-control {
        display: grid;
        grid-template-columns: 250px auto;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      }

      .threshold-control > div:first-child {
        display: flex;
        flex-direction: column;
      }

      .threshold-control label {
        font-weight: 600;
        display: block;
        margin-bottom: 2px;
      }

      .threshold-input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        width: 120px;
      }

      /* Hide number input spin buttons */
      .threshold-input::-webkit-inner-spin-button,
      .threshold-input::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .threshold-input[type="number"] {
        -moz-appearance: textfield;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: black;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .form-group textarea {
        min-height: 100px;
        font-family: monospace;
        font-size: 12px;
      }

      .char-count {
        text-align: right;
        font-size: 12px;
        color: #666;
        margin-top: 2px;
      }

      .char-count.warning {
        color: #ff9800;
      }

      .char-count.error {
        color: #f44336;
      }

      .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Login tab styles */
      .login-section {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .login-section h3 {
        margin-top: 0;
        color: #333;
      }

      .login-form {
        margin-top: 20px;
      }

      .pin-display {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
      }

      .pin-instructions {
        margin-top: 30px;
        background: #e3f2fd;
        border-radius: 8px;
        padding: 20px;
      }

      .pin-instructions h4 {
        margin-top: 0;
        color: #1976d2;
      }

      .pin-instructions ol {
        margin-bottom: 0;
      }
    </style>
    <script src="/lib/auth.js"></script>
    <script src="/lib/packing-rules.js"></script>
    <script src="/components/navigation.js"></script>
  </head>
  <body>
    <nav id="nav-container"></nav>

    <div class="rules-container">
      <div class="rules-header">
        <h1>Settings</h1>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('rules')">
          <i class="fas fa-box"></i> Packing Rules
        </div>
        <div class="tab" onclick="switchTab('engine')">
          <i class="fas fa-cog"></i> Recommendation Engine
        </div>
        <div class="tab" onclick="switchTab('logins')">
          <i class="fas fa-user-lock"></i> Logins
        </div>
      </div>

      <!-- Packing Rules Tab -->
      <div id="rulesTab" class="tab-content active">
        <div
          style="display: flex; justify-content: flex-end; margin-bottom: 20px"
        >
          <button class="btn btn-secondary" onclick="resetAllRules()">
            <i class="fas fa-undo"></i> Reset All to Defaults
          </button>
        </div>

        <div id="rulesGrid" class="rules-grid">
          <!-- Rules will be populated here -->
        </div>
      </div>

      <!-- Recommendation Engine Tab -->
      <div id="engineTab" class="tab-content">
        <div
          style="display: flex; justify-content: flex-end; margin-bottom: 20px"
        >
          <button class="btn btn-secondary" onclick="resetEngineConfig()">
            <i class="fas fa-undo"></i> Reset to Defaults
          </button>
        </div>

        <!-- Engine configuration sections -->
        <div class="engine-section">
          <h3>Scoring Weights</h3>
          <p class="help-text">
            Drag the handles to adjust the importance of each factor. The three
            segments always sum to 100%.
          </p>

          <div class="three-segment-slider" id="weightSlider">
            <div class="slider-track" id="sliderTrack">
              <div class="slider-segment segment-price" id="segmentPrice"></div>
              <div
                class="slider-segment segment-efficiency"
                id="segmentEfficiency"
              ></div>
              <div class="slider-segment segment-ease" id="segmentEase"></div>
              <div class="slider-handle" id="handle1" data-handle="1"></div>
              <div class="slider-handle" id="handle2" data-handle="2"></div>
            </div>
            <div class="slider-labels">
              <div class="slider-label">
                <div class="label-color" style="background: #2196f3"></div>
                <span>Price:</span>
                <span class="label-value" id="weightPriceValue">45%</span>
              </div>
              <div class="slider-label">
                <div class="label-color" style="background: #4caf50"></div>
                <span>Efficiency:</span>
                <span class="label-value" id="weightEfficiencyValue">25%</span>
              </div>
              <div class="slider-label">
                <div class="label-color" style="background: #ff9800"></div>
                <span>Ease:</span>
                <span class="label-value" id="weightEaseValue">30%</span>
              </div>
            </div>
          </div>
        </div>

        <div class="engine-section">
          <h3>Strategy Preferences</h3>
          <p class="help-text">
            Lower values mean more preferred. Scale: 0 (most preferred) to 10
            (avoid if possible).
          </p>

          <div class="strategy-grid">
            <div class="strategy-control">
              <label>Normal (no cuts):</label>
              <input
                type="range"
                id="strategyNormal"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyNormalValue">0</div>
            </div>
            <div class="strategy-control">
              <label>Pre-scored cuts:</label>
              <input
                type="range"
                id="strategyPrescored"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyPrescoredValue">1</div>
            </div>
            <div class="strategy-control">
              <label>Flattened:</label>
              <input
                type="range"
                id="strategyFlattened"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyFlattenedValue">2</div>
            </div>
            <div class="strategy-control">
              <label>Manual cuts:</label>
              <input
                type="range"
                id="strategyManualCut"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyManualCutValue">5</div>
            </div>
            <div class="strategy-control">
              <label>Telescoping:</label>
              <input
                type="range"
                id="strategyTelescoping"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyTelescopingValue">6</div>
            </div>
            <div class="strategy-control">
              <label>Diagonal packing:</label>
              <input
                type="range"
                id="strategyCheating"
                class="slider"
                min="0"
                max="10"
                step="1"
              />
              <div class="strategy-value" id="strategyCheatingValue">8</div>
            </div>
          </div>
        </div>

        <div class="engine-section">
          <h3>Advanced Thresholds</h3>

          <div class="threshold-controls">
            <div class="threshold-control">
              <div>
                <label
                  >Practically Tight Threshold:
                  <i
                    class="fas fa-info-circle info-icon"
                    onclick="showThresholdInfo()"
                  ></i>
                </label>
                <div class="help-text">
                  Score difference for "good enough" fit
                </div>
              </div>
              <input
                type="number"
                id="practicallyTightThreshold"
                class="threshold-input"
                min="0"
                max="20"
                step="0.5"
              />
            </div>
            <div class="threshold-control">
              <div>
                <label>Max Recommendations:</label>
                <div class="help-text">Maximum number of results to show</div>
              </div>
              <input
                type="number"
                id="maxRecommendations"
                class="threshold-input"
                min="1"
                max="20"
                step="1"
              />
            </div>
            <div class="threshold-control">
              <div>
                <label>Extreme Cut Threshold:</label>
                <div class="help-text">
                  Minimum % of box remaining after cut
                </div>
              </div>
              <input
                type="number"
                id="extremeCutThreshold"
                class="threshold-input"
                min="10"
                max="100"
                step="5"
              />
            </div>
          </div>
        </div>

        <div style="margin-top: 30px; display: flex; justify-content: center">
          <button
            class="btn btn-primary"
            onclick="saveEngineConfig()"
            style="padding: 12px 30px; font-size: 16px"
          >
            <i class="fas fa-save"></i> Save Engine Configuration
          </button>
        </div>
      </div>

      <!-- Logins Tab -->
      <div id="loginsTab" class="tab-content">
        <div class="login-section">
          <h3>Admin Login</h3>
          <p class="help-text">
            Admin users authenticate using email-based passwordless login.
          </p>
          
          <div class="login-form">
            <div class="form-group">
              <label for="adminEmail">Admin Email Address:</label>
              <input type="email" id="adminEmail" placeholder="admin@example.com" />
              <div class="help-text">This email will receive login verification codes</div>
            </div>
            
            <button class="btn btn-primary" onclick="updateAdminEmail()">
              <i class="fas fa-save"></i> Update Admin Email
            </button>
          </div>
        </div>

        <div class="login-section" style="margin-top: 40px;">
          <h3>User Login</h3>
          <p class="help-text">
            Store associates authenticate using a 6-digit PIN code.
          </p>
          
          <div class="pin-display">
            <button class="btn btn-warning" onclick="regeneratePin()">
              <i class="fas fa-sync"></i> Generate New PIN
            </button>
            <div class="help-text" id="pinUpdated" style="margin-left: 20px;"></div>
          </div>
          
          <div class="pin-instructions">
            <h4>Instructions for Store Associates:</h4>
            <ol>
              <li>Go to the login page</li>
              <li>Select "Store Associate" mode</li>
              <li>Enter the store number and 6-digit PIN</li>
              <li>Associates will have read-only access to view prices and use the packing wizard</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit/Add Rule Modal -->
    <div id="ruleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Edit Rule</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="ruleForm" onsubmit="saveRule(event)">
          <div class="form-group">
            <label for="packingType">Packing Type:</label>
            <select id="packingType" required disabled>
              <option value="Basic">Basic</option>
              <option value="Standard">Standard</option>
              <option value="Fragile">Fragile</option>
              <option value="Custom">Custom</option>
            </select>
          </div>

          <div class="form-group">
            <label for="paddingInches">Padding (inches):</label>
            <input type="number" id="paddingInches" min="0" max="10" required />
          </div>

          <div class="form-group">
            <label for="wizardDescription">Wizard Description:</label>
            <input
              type="text"
              id="wizardDescription"
              maxlength="100"
              required
              oninput="updateCharCount('wizardDescription', 100)"
            />
            <div id="wizardDescriptionCount" class="char-count">0 / 100</div>
          </div>

          <div class="form-group">
            <label for="labelInstructions">Label Instructions:</label>
            <textarea
              id="labelInstructions"
              maxlength="1000"
              required
              oninput="updateCharCount('labelInstructions', 1000)"
            ></textarea>
            <div id="labelInstructionsCount" class="char-count">0 / 1000</div>
          </div>

          <div
            style="
              margin-top: 20px;
              display: flex;
              gap: 10px;
              justify-content: flex-end;
            "
          >
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Rule</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Threshold Info Modal -->
    <div id="thresholdInfoModal" class="modal">
      <div class="modal-content threshold-info-modal">
        <div class="modal-header">
          <h2>Understanding the Practically Tight Threshold</h2>
          <span class="close" onclick="closeThresholdInfo()">&times;</span>
        </div>
        <div class="threshold-info-content">
          <p>
            The <strong>Practically Tight Threshold</strong> is a key parameter
            that helps the recommendation engine identify boxes that are "good
            enough" even if they're not the absolute tightest fit. This prevents
            the system from always recommending only the smallest possible box,
            which might be harder to pack or more expensive.
          </p>

          <h3>How It Works</h3>
          <p>
            The threshold represents the maximum "tightness score" difference
            between boxes that should be considered equally good fits. A box's
            tightness score is calculated as the sum of squared differences
            between the box dimensions and the item dimensions (including
            packing material).
          </p>

          <div class="threshold-example">
            <h4>üìê The Math</h4>
            <p>
              <code
                >Tightness Score = (boxLength - itemLength)¬≤ + (boxWidth -
                itemWidth)¬≤ + (boxHeight - itemHeight)¬≤</code
              >
            </p>
            <p>
              Lower scores mean tighter fits. A score of 0 means the item fits
              perfectly with no extra space.
            </p>
          </div>

          <div class="threshold-example">
            <h4>üéØ Example 1: Threshold = 5</h4>
            <p>
              You have an item that's <strong>10" √ó 8" √ó 6"</strong> (with
              padding included).
            </p>

            <div class="visual-example">
              <div class="box-visual highlighted">
                <strong>Box A</strong><br />
                10" √ó 8" √ó 6"<br />
                Score: 0<br />
                <em>Perfect fit!</em>
              </div>
              <div class="box-visual highlighted">
                <strong>Box B</strong><br />
                11" √ó 8" √ó 6"<br />
                Score: 1<br />
                <em>Within threshold ‚úì</em>
              </div>
              <div class="box-visual">
                <strong>Box C</strong><br />
                12" √ó 9" √ó 6"<br />
                Score: 5<br />
                <em>At threshold limit</em>
              </div>
              <div class="box-visual">
                <strong>Box D</strong><br />
                12" √ó 10" √ó 6"<br />
                Score: 8<br />
                <em>Beyond threshold ‚úó</em>
              </div>
            </div>

            <p>
              With a threshold of 5, Boxes A, B, and C would all be considered
              "practically tight" and recommended based on other factors like
              price and ease of packing. Box D would only be shown if there are
              no better options.
            </p>
          </div>

          <div class="threshold-example">
            <h4>üí° Real-World Impact</h4>
            <ul>
              <li>
                <strong>Threshold = 0:</strong> Only recommend perfect or
                near-perfect fits. Very restrictive.
              </li>
              <li>
                <strong>Threshold = 5:</strong> Allow boxes with up to ~2" total
                extra space across dimensions. Good balance.
              </li>
              <li>
                <strong>Threshold = 10:</strong> More lenient, includes boxes
                with ~3" total extra space.
              </li>
              <li>
                <strong>Threshold = 20:</strong> Very lenient, may recommend
                boxes that seem too large.
              </li>
            </ul>
          </div>
          <p>
            <strong>Note:</strong> This threshold works alongside the scoring
            weights (price, efficiency, ease) to determine final
            recommendations. Even a box within the threshold might not be
            recommended if it's significantly more expensive or harder to pack
            than alternatives.
          </p>
        </div>
      </div>
    </div>

    <script>
      let storeId;
      let allRules = [];
      let customRules = [];
      let editingRule = null;

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", async function () {
        // Get store ID from URL
        const path = window.location.pathname;
        const match = path.match(/^\/(\d{1,4})\//);
        storeId = match ? match[1] : "1";

        // Initialize navigation
        if (typeof initAdminNav !== "undefined") {
          await initAdminNav("nav-container", storeId, "settings");
        }

        // Check authentication (will redirect if needed)
        // requireAuth doesn't return a value, it redirects if needed
        // We need admin access for settings
        await AuthManager.requireAuth(storeId, true);

        // Load rules
        await loadRules();
        
        // Load login info
        await loadLoginInfo();
        
        // Initialize displays that were in the second DOMContentLoaded
        updateStrategyDisplays();
        // Initialize three-segment slider with defaults
        initializeThreeSegmentSlider(0.45, 0.25, 0.3);
      });


      async function loadRules() {
        try {
          const response = await fetch(`/api/store/${storeId}/packing-rules`);
          if (!response.ok) throw new Error("Failed to load rules");

          const data = await response.json();
          allRules = data.effective_rules;
          customRules = data.custom_rules;

          displayRules(allRules);
        } catch (error) {
          console.error("Error loading rules:", error);
          alert("Error loading rules. Please refresh the page.");
        }
      }

      function displayRules(rules) {
        const grid = document.getElementById("rulesGrid");
        if (!grid) {
          console.error("rulesGrid element not found!");
          return;
        }
        grid.innerHTML = "";

        if (!rules || rules.length === 0) {
          grid.innerHTML = '<p>No packing rules found.</p>';
          return;
        }

        rules.forEach((rule) => {
          const card = document.createElement("div");
          card.className = `rule-card ${rule.is_custom ? "custom" : "default"}`;

          const paddingText =
            rule.padding_inches === 0
              ? "No padding required"
              : `${rule.padding_inches}" padding on all sides`;

          card.innerHTML = `
                    <div class="rule-header">
                        <div class="rule-title">${rule.packing_type} Pack</div>
                        <span class="rule-badge ${
                          rule.is_custom ? "badge-custom" : "badge-default"
                        }">
                            ${rule.is_custom ? "‚úì Custom" : "‚ö™ Default"}
                        </span>
                    </div>
                    <div class="rule-details">
                        <div class="rule-field">
                            <span class="field-label">Padding:</span>
                            <span class="field-value">${paddingText}</span>
                        </div>
                        <div class="rule-field">
                            <span class="field-label">Description:</span>
                            <span class="field-value">${
                              rule.wizard_description
                            }</span>
                        </div>
                        <div class="rule-field">
                            <span class="field-label">Instructions:</span>
                            <div class="field-value">
                                <div class="instructions-preview">${
                                  rule.label_instructions
                                }</div>
                            </div>
                        </div>
                    </div>
                    <div class="rule-actions">
                        <button class="btn btn-primary" onclick='editRule(${JSON.stringify(
                          rule
                        )})'>
                            <i class="fas fa-edit"></i> ${
                              rule.is_custom ? "Edit" : "Customize"
                            }
                        </button>
                    </div>
                `;

          grid.appendChild(card);
        });
      }

      function editRule(rule) {
        editingRule = rule;
        document.getElementById(
          "modalTitle"
        ).textContent = `Edit ${rule.packing_type} Pack`;

        // Populate form
        document.getElementById("packingType").value = rule.packing_type;
        document.getElementById("paddingInches").value = rule.padding_inches;
        document.getElementById("wizardDescription").value =
          rule.wizard_description;
        document.getElementById("labelInstructions").value =
          rule.label_instructions;

        // Update character counts
        updateCharCount("wizardDescription", 100);
        updateCharCount("labelInstructions", 1000);

        document.getElementById("ruleModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("ruleModal").style.display = "none";
        editingRule = null;
      }

      function showThresholdInfo() {
        document.getElementById("thresholdInfoModal").style.display = "block";
      }

      function closeThresholdInfo() {
        document.getElementById("thresholdInfoModal").style.display = "none";
      }

      function updateCharCount(fieldId, maxLength) {
        const field = document.getElementById(fieldId);
        const count = field.value.length;
        const countElement = document.getElementById(fieldId + "Count");

        countElement.textContent = `${count} / ${maxLength}`;

        if (count > maxLength * 0.9) {
          countElement.className = "char-count error";
        } else if (count > maxLength * 0.7) {
          countElement.className = "char-count warning";
        } else {
          countElement.className = "char-count";
        }
      }

      async function saveRule(event) {
        event.preventDefault();

        const formData = {
          packing_type: document.getElementById("packingType").value,
          padding_inches: parseInt(
            document.getElementById("paddingInches").value
          ),
          wizard_description:
            document.getElementById("wizardDescription").value,
          label_instructions:
            document.getElementById("labelInstructions").value,
        };

        // Build the complete list of rules to save
        let rulesToSave = [...customRules];

        // Remove any existing rule for this packing type
        rulesToSave = rulesToSave.filter(
          (r) => r.packing_type !== formData.packing_type
        );

        // Add the new/updated rule
        rulesToSave.push(formData);

        try {
          const token = AuthManager.getToken(storeId);
          const response = await fetch(`/api/store/${storeId}/packing-rules`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ rules: rulesToSave }),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Failed to save rules");
          }

          closeModal();
          await loadRules();
        } catch (error) {
          console.error("Error saving rule:", error);
          alert("Error saving rule: " + error.message);
        }
      }

      async function resetAllRules() {
        if (
          !confirm(
            "Are you sure you want to reset ALL rules to defaults? This cannot be undone."
          )
        ) {
          return;
        }

        try {
          const token = AuthManager.getToken(storeId);
          const response = await fetch(`/api/store/${storeId}/packing-rules`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) throw new Error("Failed to reset rules");

          await loadRules();
        } catch (error) {
          console.error("Error resetting rules:", error);
          alert("Error resetting rules. Please try again.");
        }
      }

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("ruleModal");
        const thresholdModal = document.getElementById("thresholdInfoModal");
        if (event.target === modal) {
          closeModal();
        } else if (event.target === thresholdModal) {
          closeThresholdInfo();
        }
      };

      // Tab switching
      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.closest(".tab").classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        if (tabName === "rules") {
          document.getElementById("rulesTab").classList.add("active");
        } else if (tabName === "engine") {
          document.getElementById("engineTab").classList.add("active");
          // Load engine config if not already loaded
          if (!engineConfigLoaded) {
            loadEngineConfig();
          }
        } else if (tabName === "logins") {
          document.getElementById("loginsTab").classList.add("active");
          // Refresh login info when switching to logins tab
          loadLoginInfo();
        }
      }

      // Engine configuration management
      let engineConfig = null;
      let engineConfigLoaded = false;

      async function loadEngineConfig() {
        try {
          const response = await fetch(`/api/store/${storeId}/engine-config`);
          if (!response.ok) throw new Error("Failed to load engine config");

          engineConfig = await response.json();
          engineConfigLoaded = true;

          // Update UI with loaded values
          updateEngineUI();
        } catch (error) {
          console.error("Error loading engine config:", error);
          alert("Error loading engine configuration. Please refresh the page.");
        }
      }

      function updateEngineUI() {
        if (!engineConfig) return;

        // Initialize three-segment slider with loaded values
        initializeThreeSegmentSlider(
          engineConfig.weights.price,
          engineConfig.weights.efficiency,
          engineConfig.weights.ease
        );

        // Update strategy sliders
        document.getElementById("strategyNormal").value =
          engineConfig.strategy_preferences.normal;
        document.getElementById("strategyPrescored").value =
          engineConfig.strategy_preferences.prescored;
        document.getElementById("strategyFlattened").value =
          engineConfig.strategy_preferences.flattened;
        document.getElementById("strategyManualCut").value =
          engineConfig.strategy_preferences.manual_cut;
        document.getElementById("strategyTelescoping").value =
          engineConfig.strategy_preferences.telescoping;
        document.getElementById("strategyCheating").value =
          engineConfig.strategy_preferences.cheating;

        // Update threshold inputs
        document.getElementById("practicallyTightThreshold").value =
          engineConfig.practically_tight_threshold;
        document.getElementById("maxRecommendations").value =
          engineConfig.max_recommendations;
        // Convert decimal to percentage for display
        document.getElementById("extremeCutThreshold").value = Math.round(
          engineConfig.extreme_cut_threshold * 100
        );

        // Update all displays
        updateStrategyDisplays();
      }

      // Three-segment slider implementation
      let sliderWeights = { price: 0.45, efficiency: 0.25, ease: 0.3 };
      let isDragging = false;
      let currentHandle = null;

      function initializeThreeSegmentSlider(price, efficiency, ease) {
        sliderWeights = { price, efficiency, ease };
        updateSliderVisuals();

        // Add event listeners if not already added
        const track = document.getElementById("sliderTrack");
        const handle1 = document.getElementById("handle1");
        const handle2 = document.getElementById("handle2");

        if (!handle1.hasAttribute("data-listeners-added")) {
          // Mouse events
          handle1.addEventListener("mousedown", startDrag);
          handle2.addEventListener("mousedown", startDrag);
          document.addEventListener("mousemove", drag);
          document.addEventListener("mouseup", stopDrag);

          // Touch events
          handle1.addEventListener("touchstart", startDrag);
          handle2.addEventListener("touchstart", startDrag);
          document.addEventListener("touchmove", drag);
          document.addEventListener("touchend", stopDrag);

          // Click on track to move nearest handle
          track.addEventListener("click", trackClick);

          handle1.setAttribute("data-listeners-added", "true");
          handle2.setAttribute("data-listeners-added", "true");
        }
      }

      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        currentHandle = e.target;
        currentHandle.classList.add("dragging");
      }

      function drag(e) {
        if (!isDragging || !currentHandle) return;

        const track = document.getElementById("sliderTrack");
        const rect = track.getBoundingClientRect();
        const clientX = e.type.includes("touch")
          ? e.touches[0].clientX
          : e.clientX;
        const x = clientX - rect.left;
        const percent = Math.max(0, Math.min(1, x / rect.width));

        // Update weights based on which handle is being dragged
        const minSegment = 0.05; // 5% minimum for any segment
        const maxSegment = 0.9; // 90% maximum for any segment

        if (currentHandle.dataset.handle === "1") {
          // First handle controls price/efficiency split
          // Constrain to reasonable bounds
          const minPrice = minSegment;
          const maxPrice = Math.min(
            maxSegment,
            1 - sliderWeights.ease - minSegment
          );
          sliderWeights.price = Math.max(minPrice, Math.min(maxPrice, percent));
          sliderWeights.efficiency =
            1 - sliderWeights.price - sliderWeights.ease;

          // Ensure efficiency doesn't go below minimum
          if (sliderWeights.efficiency < minSegment) {
            sliderWeights.efficiency = minSegment;
            sliderWeights.price =
              1 - sliderWeights.efficiency - sliderWeights.ease;
          }
        } else {
          // Second handle controls efficiency/ease split
          // Constrain to reasonable bounds
          const effPlusEase = 1 - sliderWeights.price;
          const easePercent = 1 - percent;
          const maxEase = Math.min(maxSegment, effPlusEase - minSegment);
          sliderWeights.ease = Math.max(
            minSegment,
            Math.min(maxEase, easePercent * effPlusEase)
          );
          sliderWeights.efficiency = effPlusEase - sliderWeights.ease;

          // Ensure efficiency doesn't go below minimum
          if (sliderWeights.efficiency < minSegment) {
            sliderWeights.efficiency = minSegment;
            sliderWeights.ease = effPlusEase - sliderWeights.efficiency;
          }
        }

        updateSliderVisuals();
      }

      function stopDrag() {
        if (currentHandle) {
          currentHandle.classList.remove("dragging");
        }
        isDragging = false;
        currentHandle = null;
      }

      function trackClick(e) {
        if (isDragging) return;

        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = x / rect.width;

        // Determine which handle is closer
        const handle1Pos = sliderWeights.price;
        const handle2Pos = sliderWeights.price + sliderWeights.efficiency;

        if (Math.abs(percent - handle1Pos) < Math.abs(percent - handle2Pos)) {
          currentHandle = document.getElementById("handle1");
        } else {
          currentHandle = document.getElementById("handle2");
        }

        drag(e);
        stopDrag();
      }

      function updateSliderVisuals() {
        // Update segment widths
        document.getElementById("segmentPrice").style.width =
          sliderWeights.price * 100 + "%";
        document.getElementById("segmentEfficiency").style.width =
          sliderWeights.efficiency * 100 + "%";
        document.getElementById("segmentEfficiency").style.left =
          sliderWeights.price * 100 + "%";
        document.getElementById("segmentEase").style.width =
          sliderWeights.ease * 100 + "%";

        // Update handle positions
        document.getElementById("handle1").style.left = `calc(${
          sliderWeights.price * 100
        }% - 12px)`;
        document.getElementById("handle2").style.left = `calc(${
          (sliderWeights.price + sliderWeights.efficiency) * 100
        }% - 12px)`;

        // Update labels
        document.getElementById("weightPriceValue").textContent =
          Math.round(sliderWeights.price * 100) + "%";
        document.getElementById("weightEfficiencyValue").textContent =
          Math.round(sliderWeights.efficiency * 100) + "%";
        document.getElementById("weightEaseValue").textContent =
          Math.round(sliderWeights.ease * 100) + "%";
      }

      function updateStrategyDisplays() {
        // Update all strategy value displays
        const strategies = [
          "Normal",
          "Prescored",
          "Flattened",
          "ManualCut",
          "Telescoping",
          "Cheating",
        ];
        strategies.forEach((strategy) => {
          const slider = document.getElementById("strategy" + strategy);
          const display = document.getElementById(
            "strategy" + strategy + "Value"
          );
          if (slider && display) {
            display.textContent = slider.value;

            // Add event listener if not already added
            if (!slider.hasAttribute("data-listener-added")) {
              slider.addEventListener("input", function () {
                display.textContent = this.value;
              });
              slider.setAttribute("data-listener-added", "true");
            }
          }
        });
      }

      async function saveEngineConfig() {
        // Get current values from three-segment slider
        const price = sliderWeights.price;
        const efficiency = sliderWeights.efficiency;
        const ease = sliderWeights.ease;

        const config = {
          weights: {
            price: price,
            efficiency: efficiency,
            ease: ease,
          },
          strategy_preferences: {
            normal: parseInt(document.getElementById("strategyNormal").value),
            prescored: parseInt(
              document.getElementById("strategyPrescored").value
            ),
            flattened: parseInt(
              document.getElementById("strategyFlattened").value
            ),
            manual_cut: parseInt(
              document.getElementById("strategyManualCut").value
            ),
            telescoping: parseInt(
              document.getElementById("strategyTelescoping").value
            ),
            cheating: parseInt(
              document.getElementById("strategyCheating").value
            ),
          },
          practically_tight_threshold: parseFloat(
            document.getElementById("practicallyTightThreshold").value
          ),
          max_recommendations: parseInt(
            document.getElementById("maxRecommendations").value
          ),
          // Convert percentage back to decimal for storage
          extreme_cut_threshold:
            parseFloat(document.getElementById("extremeCutThreshold").value) /
            100,
        };

        try {
          const token = AuthManager.getToken(storeId);
          const response = await fetch(`/api/store/${storeId}/engine-config`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(config),
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || "Failed to save configuration");
          }

          alert("Engine configuration saved successfully!");
          engineConfig = { ...engineConfig, ...config };
        } catch (error) {
          console.error("Error saving engine config:", error);
          alert("Error saving configuration: " + error.message);
        }
      }

      async function resetEngineConfig() {
        if (
          !confirm(
            "Reset engine configuration to defaults? This cannot be undone."
          )
        ) {
          return;
        }

        try {
          const token = AuthManager.getToken(storeId);
          const response = await fetch(`/api/store/${storeId}/engine-config`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) throw new Error("Failed to reset configuration");

          // Reload config
          await loadEngineConfig();
          alert("Engine configuration reset to defaults!");
        } catch (error) {
          console.error("Error resetting engine config:", error);
          alert("Error resetting configuration. Please try again.");
        }
      }

      // This initialization is now done in the main DOMContentLoaded handler

      // Helper function to convert timestamps to relative time
      function getRelativeTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMs < 0) return 'in the future';
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 30) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        
        // For older dates, show the actual date
        return date.toLocaleDateString();
      }

      // Login tab functions
      async function loadLoginInfo() {
        try {
          // Get store info to load admin email
          const response = await fetch(`/api/store/${storeId}/info`, {
            headers: {
              'Authorization': `Bearer ${AuthManager.getToken(storeId)}`
            }
          });
          if (response.ok) {
            const data = await response.json();
            if (data.admin_email) {
              document.getElementById('adminEmail').value = data.admin_email;
            }
          }
          
          // Get PIN info (we don't get the actual PIN for security)
          const pinResponse = await fetch(`/api/store/${storeId}/pin`, {
            headers: {
              'Authorization': `Bearer ${AuthManager.getToken(storeId)}`
            }
          });
          if (pinResponse.ok) {
            const pinData = await pinResponse.json();
            if (pinData.updated_at) {
              document.getElementById('pinUpdated').textContent = 
                `PIN last updated: ${getRelativeTime(pinData.updated_at)}`;
            }
          }
        } catch (error) {
          console.error('Error loading login info:', error);
        }
      }

      async function updateAdminEmail() {
        const email = document.getElementById('adminEmail').value;
        if (!email) {
          alert('Please enter a valid email address');
          return;
        }

        try {
          const response = await fetch(`/api/store/${storeId}/admin-email`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${AuthManager.getToken(storeId)}`
            },
            body: JSON.stringify({ email })
          });

          if (response.ok) {
            alert('Admin email updated successfully!');
          } else {
            const error = await response.json();
            alert('Error updating email: ' + (error.detail || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error updating admin email:', error);
          alert('Error updating email. Please try again.');
        }
      }

      async function regeneratePin() {
        if (!confirm('Are you sure you want to generate a new PIN? This will invalidate the current PIN.')) {
          return;
        }

        try {
          const response = await fetch(`/api/store/${storeId}/regenerate-pin`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${AuthManager.getToken(storeId)}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            
            // Update the timestamp with the new PIN
            document.getElementById('pinUpdated').innerHTML = 
              `<strong style="color: #4CAF50;">New PIN: ${data.pin}</strong> - Please share this with store associates`;
            
            alert(`New PIN generated: ${data.pin}\n\nPlease share this with store associates who need access.`);
            
            // After 30 seconds, update to show just the timestamp
            setTimeout(() => {
              document.getElementById('pinUpdated').textContent = 
                `PIN last updated: Just now`;
            }, 30000);
          } else {
            const error = await response.json();
            alert('Error regenerating PIN: ' + (error.detail || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error regenerating PIN:', error);
          alert('Error regenerating PIN. Please try again.');
        }
      }
    </script>
  </body>
</html>
