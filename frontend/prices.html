<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Box Prices</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.4/css/select.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/print.css">
    <link rel="stylesheet" type="text/css" href="/assets/css/common.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: none !important;
            margin: 0;
            padding: 15px;
            flex: 1;
        }
        .header {
            margin-bottom: 20px;
        }
        .dataTables_wrapper {
            margin-top: 20px;
        }
        
        /* Editable cells */
        .editable {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .editable:hover {
            background-color: #e9ecef;
        }
        
        /* Remove spinner buttons from number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        
        /* Position the search box */
        .dataTables_filter {
            float: left !important;
            margin-bottom: 10px;
            margin-left: 0;
        }
        .dataTables_filter label {
            margin-bottom: 0;
            display: flex;
            align-items: center;
        }
        .dataTables_filter input {
            margin-left: 5px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        /* Section headers */
        .section-header {
            background-color: #343a40;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
        }
        
        /* Row colors by section */
        .blue-row { background-color: #cfe2f3 !important; }
        .yellow-row { background-color: #fff2cc !important; }
        .green-row { background-color: #d9ead3 !important; }
        .pink-row { background-color: #f4cccc !important; }
        .orange-row { background-color: #fce5cd !important; }
        .normal-row { background-color: rgba(135, 206, 250, 0.3) !important; }
        .custom-row { background-color: rgba(221, 160, 221, 0.3) !important; }
        
        /* Print button */
        .print-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        .print-button:hover {
            background-color: #45a049;
        }
        
        /* Box price cell - transparent to show row color */
        td.box-price-cell,
        td.editable.box-price-cell {
            background-color: transparent !important;
        }
        
        /* Column color groups - more specific to override .editable */
        td.basic-group,
        td.editable.basic-group,
        td.total-cell.basic-group {
            background-color: rgba(230, 230, 250, 0.3) !important;
        }
        td.standard-group,
        td.editable.standard-group,
        td.total-cell.standard-group {
            background-color: rgba(152, 251, 152, 0.3) !important;
        }
        td.fragile-group,
        td.editable.fragile-group,
        td.total-cell.fragile-group {
            background-color: rgba(255, 218, 185, 0.3) !important;
        }
        td.custom-group,
        td.editable.custom-group,
        td.total-cell.custom-group {
            background-color: rgba(255, 182, 193, 0.3) !important;
        }
        
        /* Group headers */
        .group-header {
            text-align: center;
            font-weight: bold;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .group-header.basic-group {
            background-color: rgba(230, 230, 250, 0.5);
        }
        .group-header.standard-group {
            background-color: rgba(152, 251, 152, 0.5);
        }
        .group-header.fragile-group {
            background-color: rgba(255, 218, 185, 0.5);
        }
        .group-header.custom-group {
            background-color: rgba(255, 182, 193, 0.5);
        }
        
        /* Combined box details column for view mode */
        .box-details {
            line-height: 1.4;
        }
        .dimensions-line {
            font-weight: bold;
        }
        .model-line {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Change tracking */
        .changes-pending {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        /* Status messages */
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-message.loading {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        /* Undo button */
        .undo-btn {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .undo-btn:hover {
            background: #5a6268;
        }
        .undo-btn.show-undo {
            opacity: 1 !important;
        }
        
        /* Total cells */
        .total-cell {
            font-weight: bold;
            background-color: rgba(0, 0, 0, 0.03) !important;
        }
        
        /* Icons */
        th img {
            cursor: help;
        }
        
        /* Location buttons */
        .location-buttons {
            display: flex;
            gap: 3px;
            align-items: center;
            justify-content: center;
        }
        
        .location-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .location-btn:hover:not(:disabled) {
            background-color: #f0f0f0;
            border-color: #999;
        }
        
        .location-btn:disabled {
            cursor: not-allowed;
        }
        
        .location-btn svg {
            width: 14px;
            height: 14px;
            display: block;
        }
        
        /* Inline location button in box details */
        .inline-location-btn {
            display: inline-block;
            padding: 0 2px;
            vertical-align: middle;
            margin-left: 4px;
        }
        .inline-location-btn svg {
            display: inline-block;
            vertical-align: text-bottom;
        }
        
        /* Hide section column in read-only mode on screen */
        @media screen {
            body:not(.admin-authenticated) #priceTable thead tr:first-child th:first-child,
            body:not(.admin-authenticated) #priceTable tbody td:first-child {
                display: none;
            }
        }
        
        /* Screen/print column visibility */
        .print-only {
            display: none !important;
        }
        
        /* Print-specific styles */
        @media print {
            /* Force portrait orientation with minimal margins */
            @page {
                orientation: portrait;
                size: 8.5in 11in;
                margin: 0.5in 0.25in; /* top/bottom: 0.5in, left/right: 0.25in */
            }
            
            /* Container width for portrait orientation */
            .container {
                width: 100% !important;
                max-width: none !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                orphans: 3;
                widows: 3;
            }
            
            /* Remove any top margin/padding from table wrapper */
            .dataTables_wrapper {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }
            
            /* Adjust table font sizes */
            table.dataTable {
                font-size: 11pt !important;
                width: 100% !important;
            }
            
            table.dataTable th,
            table.dataTable td {
                padding: 3px 5px !important;
                font-size: 10pt !important;
            }
            
            /* Always show section column in print */
            #priceTable th:first-child,
            #priceTable td:first-child {
                display: table-cell !important;
            }
            
            /* Hide sorting indicators */
            table.dataTable thead th {
                cursor: default !important;
                position: static !important;
            }
            table.dataTable thead th:after,
            table.dataTable thead th:before {
                display: none !important;
            }
            table.dataTable thead .sorting,
            table.dataTable thead .sorting_asc,
            table.dataTable thead .sorting_desc,
            table.dataTable thead .sorting_asc_disabled,
            table.dataTable thead .sorting_desc_disabled {
                background-image: none !important;
                cursor: default !important;
            }
            
            /* Hide location column in print (both edit and view modes) */
            /* Admin mode uses emoji pin header */
            th[title="Location"] {
                display: none !important;
            }
            
            /* Hide location cells that contain the location buttons */
            #priceTable td:has(.location-buttons) {
                display: none !important;
            }
            
            /* Fallback for older browsers - hide by position if it's the last column */
            .admin-authenticated #priceTable.editable-mode thead tr th:last-child[title="Location"],
            .admin-authenticated #priceTable.editable-mode tbody tr td:last-child {
                display: none !important;
            }
            
            /* Hide location eyeball buttons */
            .location-btn,
            .inline-location-btn {
                display: none !important;
            }
            
            /* Show print columns, hide screen columns */
            .print-only {
                display: table-cell !important;
            }
            .screen-only {
                display: none !important;
            }
            
            /* Smart page break handling for DataTables */
            /* Ensure DataTables wrapper doesn't interfere with page breaks */
            .dataTables_wrapper {
                page-break-inside: auto !important;
            }
            
            /* Allow natural page breaks within table */
            #priceTable tbody tr {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            /* Prevent orphaned rows - keep at least 3 rows together */
            #priceTable tbody {
                orphans: 3;
                widows: 3;
            }
            
            /* Section-based page break hints */
            /* Avoid breaks within small sections */
            #priceTable tbody tr[data-section="CUBE"] {
                page-break-after: avoid;
            }
            
            /* Allow break after LARGE section if needed */
            #priceTable tbody tr[data-section="LARGE"]:last-child {
                page-break-after: auto;
            }
            
            /* Suggest break before SPECIALTY if not at page top */
            #priceTable tbody tr[data-section="SPECIALTY"]:first-child {
                page-break-before: auto;
            }
            
            /* Hide interactive elements */
            .buttons-container,
            .status-message,
            #editInstructions,
            #readOnlyMessage,
            .undo-btn,
            .dataTables_length,
            .dataTables_filter,
            .dataTables_info,
            .dataTables_paginate,
            .admin-nav,
            .header {
                display: none !important;
            }
            
            /* Make table full width */
            table.dataTable {
                width: 100% !important;
                page-break-inside: auto;
            }
            
            /* Compact spacing */
            table.dataTable th,
            table.dataTable td {
                padding: 3px 5px !important;
            }
            
            /* Ensure colors are preserved */
            * {
                color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            /* Body margins - already handled by @page, so remove to avoid double margins */
            body {
                margin: 0;
            }
        }
        
        /* Floorplan modal styles */
        .floorplan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }
        
        .floorplan-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .floorplan-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .floorplan-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .floorplan-container {
            position: relative;
            display: inline-block;
            cursor: crosshair;
        }
        
        .floorplan-container img {
            max-width: 800px;
            max-height: 600px;
            display: block;
        }
        
        .location-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            margin-left: -15px;
            margin-top: -15px;
            background: red;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="container">
            <div class="header">
                <h1 id="storeHeader">Box Prices</h1>
                <p id="editInstructions">Click on any price cell to edit. Your changes will be tracked and can be saved to the YAML file.</p>
            </div>
            
            <div class="buttons-container">
                <button id="saveChanges" disabled>Save Changes</button>
                <span id="changeCount" style="margin-left: 20px;">No changes pending</span>
                <button class="print-button" onclick="window.print()">Print Table</button>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
            
            <div id="priceTableContainer">
                <!-- Table will be inserted here by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Floorplan Modal -->
    <div id="floorplanModal" class="floorplan-modal">
        <div class="floorplan-modal-content">
            <div class="floorplan-modal-header">
                <h3 id="floorplanModalTitle">Box Location</h3>
                <button class="floorplan-modal-close" onclick="closeFloorplanModal()">&times;</button>
            </div>
            <div class="floorplan-container" id="floorplanContainer">
                <!-- Floorplan image and marker will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.4/js/dataTables.select.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
    <script src="/js/lib/auth.js"></script>
    <script src="/js/lib/api.js"></script>
    <script src="/js/components/navigation.js"></script>
    <script src="/js/components/price-table.js"></script>
    <script src="/js/components/price-table-view.js"></script>
    <script src="/js/components/price-table-edit.js"></script>
    
    <script>
        // Get store ID from URL
        const storeId = window.location.pathname.split('/')[1];
        let priceTable = null;
        
        // Generate a CSRF token for this session
        const csrfToken = Math.random().toString(36).substring(2, 15) +
                         Math.random().toString(36).substring(2, 15);
        window.csrfToken = csrfToken; // Make it globally available
        
        // Location viewer function with floorplan modal
        async function openLocationViewer(model, location) {
            if (!location || !location.coords || location.coords.length === 0) {
                alert('No location coordinates set for this box.');
                return;
            }
            
            // Handle different coordinate formats
            let x, y;
            if (Array.isArray(location.coords[0])) {
                // Format: [[x, y]]
                [x, y] = location.coords[0];
            } else if (typeof location.coords[0] === 'object' && location.coords[0].x !== undefined) {
                // Format: [{x: val, y: val}]
                x = location.coords[0].x;
                y = location.coords[0].y;
            } else if (location.coords.length === 2 && typeof location.coords[0] === 'number') {
                // Format: [x, y]
                [x, y] = location.coords;
            } else {
                // Unknown format
                console.error('Unknown coordinate format:', location.coords);
                return;
            }
            
            // Load floorplan
            try {
                const response = await fetch(`/api/store/${storeId}/floorplan`);
                if (!response.ok) {
                    alert('No floorplan available for this store.');
                    return;
                }
                
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                // Show modal
                const modal = document.getElementById('floorplanModal');
                const container = document.getElementById('floorplanContainer');
                const title = document.getElementById('floorplanModalTitle');
                
                title.textContent = `${model} - ${location.label || 'Location'}`;
                
                // Clear previous content
                container.innerHTML = '';
                
                // Create image
                const img = document.createElement('img');
                img.src = imageUrl;
                img.onload = function() {
                    // Add marker at the location
                    const marker = document.createElement('div');
                    marker.className = 'location-marker';
                    marker.style.left = (x * 100) + '%';
                    marker.style.top = (y * 100) + '%';
                    marker.title = model;
                    
                    container.appendChild(img);
                    container.appendChild(marker);
                };
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading floorplan:', error);
                alert('Failed to load floorplan.');
            }
        }
        
        // Close floorplan modal
        function closeFloorplanModal() {
            const modal = document.getElementById('floorplanModal');
            modal.style.display = 'none';
            
            // Clean up any extra elements added for edit mode
            const modalContent = modal.querySelector('.floorplan-modal-content');
            const buttonContainer = modalContent.querySelector('div[style*="margin-top: 15px"]');
            
            if (buttonContainer) buttonContainer.remove();
            
            // Reset container click handler
            const container = document.getElementById('floorplanContainer');
            container.onclick = null;
            container.style.cursor = 'default';
        }
        
        // Close modal when clicking outside
        document.getElementById('floorplanModal').onclick = function(e) {
            if (e.target === this) {
                closeFloorplanModal();
            }
        };
        
        // Location editor function with floorplan modal
        async function openLocationEditor(model, currentLocation, callback) {
            // First check if floorplan exists
            try {
                const response = await fetch(`/api/store/${storeId}/floorplan`);
                if (!response.ok) {
                    alert('No floorplan available for this store.');
                    return;
                }
                
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                // Show modal in edit mode
                const modal = document.getElementById('floorplanModal');
                const container = document.getElementById('floorplanContainer');
                const title = document.getElementById('floorplanModalTitle');
                
                title.textContent = `Set Location for ${model}`;
                
                // Clear previous content
                container.innerHTML = '';
                
                // Create image
                const img = document.createElement('img');
                img.src = imageUrl;
                
                let marker = null;
                let currentCoords = null;
                
                // If there's an existing location, show it
                if (currentLocation && currentLocation.coords && currentLocation.coords.length > 0) {
                    let x, y;
                    if (Array.isArray(currentLocation.coords[0])) {
                        [x, y] = currentLocation.coords[0];
                    } else if (typeof currentLocation.coords[0] === 'object' && currentLocation.coords[0].x !== undefined) {
                        x = currentLocation.coords[0].x;
                        y = currentLocation.coords[0].y;
                    } else if (currentLocation.coords.length === 2 && typeof currentLocation.coords[0] === 'number') {
                        [x, y] = currentLocation.coords;
                    }
                    
                    if (x !== undefined && y !== undefined) {
                        currentCoords = {x, y};
                    }
                }
                
                img.onload = function() {
                    container.appendChild(img);
                    
                    // Add existing marker if location exists
                    if (currentCoords) {
                        marker = document.createElement('div');
                        marker.className = 'location-marker';
                        marker.style.left = (currentCoords.x * 100) + '%';
                        marker.style.top = (currentCoords.y * 100) + '%';
                        container.appendChild(marker);
                    }
                    
                    // Make container clickable
                    container.style.cursor = 'crosshair';
                    container.onclick = function(e) {
                        const rect = container.getBoundingClientRect();
                        const imgRect = img.getBoundingClientRect();
                        
                        // Calculate click position relative to image
                        const x = (e.clientX - imgRect.left) / imgRect.width;
                        const y = (e.clientY - imgRect.top) / imgRect.height;
                        
                        // Remove old marker if exists
                        if (marker) {
                            marker.remove();
                        }
                        
                        // Add new marker
                        marker = document.createElement('div');
                        marker.className = 'location-marker';
                        marker.style.left = (x * 100) + '%';
                        marker.style.top = (y * 100) + '%';
                        container.appendChild(marker);
                        
                        currentCoords = {x, y};
                    };
                };
                
                // Add save/cancel buttons
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = 'margin-top: 15px; text-align: center;';
                
                const saveBtn = document.createElement('button');
                saveBtn.textContent = 'Save Location';
                saveBtn.className = 'btn btn-primary';
                saveBtn.style.marginRight = '10px';
                saveBtn.onclick = function() {
                    if (currentCoords) {
                        const newLocation = {
                            label: currentLocation?.label || '',
                            coords: [currentCoords.x, currentCoords.y]  // Send as flat array, not nested
                        };
                        callback(newLocation);
                        closeFloorplanModal();
                    } else {
                        alert('Please click on the floorplan to set a location.');
                    }
                };
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.className = 'btn';
                cancelBtn.onclick = closeFloorplanModal;
                
                buttonContainer.appendChild(saveBtn);
                buttonContainer.appendChild(cancelBtn);
                
                modal.querySelector('.floorplan-modal-content').appendChild(buttonContainer);
                
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading floorplan:', error);
                alert('Failed to load floorplan.');
            }
        }
        
        // Initialize navigation
        initAdminNav('app-container', storeId, 'prices');
        
        // Update document title to include store ID
        document.title = `Box Prices - Store ${storeId}`;
        
        // Handle print events for better DataTables compatibility
        window.addEventListener('beforeprint', function() {
            // Ensure all rows are visible for printing
            if (priceTable && priceTable.dataTable) {
                try {
                    // Temporarily show all rows
                    priceTable.dataTable.page.len(-1).draw();
                    
                    // For view mode, we need to temporarily rebuild the table with admin layout
                    if (!priceTable.isEditable) {
                        // Save current table state
                        window.printState = {
                            currentData: priceTable.dataTable.rows().data().toArray()
                        };
                        
                        // Destroy current DataTable
                        priceTable.dataTable.destroy();
                    
                    // Rebuild table with admin layout (separate Model/Dimensions columns)
                    const $table = $('#priceTable');
                    $table.empty();
                    
                    // Build admin-style header
                    let headerHtml = '<thead>';
                    
                    if (priceTable.pricingMode === 'standard') {
                        // Standard mode - single header row
                        headerHtml += '<tr>';
                        headerHtml += '<th>Section</th>';
                        
                        if (priceTable.renderer.hasRealModels) {
                            headerHtml += '<th>Model</th>';
                        }
                        headerHtml += '<th>Dimensions</th>';
                        headerHtml += '<th>Box Price</th>';
                        headerHtml += '<th><img src="/assets/icons/total.png" width="24" height="24" alt="Basic Total" title="Basic Total"></th>';
                        headerHtml += '<th><img src="/assets/icons/total.png" width="24" height="24" alt="Standard Total" title="Standard Total"></th>';
                        headerHtml += '<th><img src="/assets/icons/total.png" width="24" height="24" alt="Fragile Total" title="Fragile Total"></th>';
                        headerHtml += '<th><img src="/assets/icons/total.png" width="24" height="24" alt="Custom Total" title="Custom Total"></th>';
                        headerHtml += '</tr>';
                    } else {
                        // Itemized mode - two header rows with proper rowspan
                        headerHtml += '<tr>';
                        headerHtml += '<th rowspan="2">Section</th>';
                        
                        if (priceTable.renderer.hasRealModels) {
                            headerHtml += '<th rowspan="2">Model</th>';
                        }
                        headerHtml += '<th rowspan="2">Dimensions</th>';
                        headerHtml += '<th rowspan="2">Box Price</th>';
                        
                        // Group headers
                        headerHtml += '<th colspan="3" class="group-header basic-group">Basic Pack</th>';
                        headerHtml += '<th colspan="3" class="group-header standard-group">Standard Pack</th>';
                        headerHtml += '<th colspan="3" class="group-header fragile-group">Fragile Pack</th>';
                        headerHtml += '<th colspan="3" class="group-header custom-group">Custom Pack</th>';
                        headerHtml += '</tr>';
                        
                        // Second row with individual columns
                        headerHtml += '<tr>';
                        // Basic group
                        headerHtml += '<th class="basic-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Basic Materials"></th>';
                        headerHtml += '<th class="basic-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Basic Services"></th>';
                        headerHtml += '<th class="basic-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Basic Total"></th>';
                        // Standard group
                        headerHtml += '<th class="standard-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Standard Materials"></th>';
                        headerHtml += '<th class="standard-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Standard Services"></th>';
                        headerHtml += '<th class="standard-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Standard Total"></th>';
                        // Fragile group
                        headerHtml += '<th class="fragile-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Fragile Materials"></th>';
                        headerHtml += '<th class="fragile-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Fragile Services"></th>';
                        headerHtml += '<th class="fragile-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Fragile Total"></th>';
                        // Custom group
                        headerHtml += '<th class="custom-group"><img src="/assets/icons/materials.png" width="24" height="24" alt="Materials" title="Custom Materials"></th>';
                        headerHtml += '<th class="custom-group"><img src="/assets/icons/services.png" width="24" height="24" alt="Services" title="Custom Services"></th>';
                        headerHtml += '<th class="custom-group"><img src="/assets/icons/total.png" width="24" height="24" alt="Total" title="Custom Total"></th>';
                        headerHtml += '</tr>';
                    }
                    
                    headerHtml += '</thead><tbody></tbody>';
                    $table.html(headerHtml);
                    
                    // Define columns for admin layout
                    const columns = [
                        { data: 'section' }
                    ];
                    
                    if (priceTable.renderer.hasRealModels) {
                        columns.push({ data: 'model' });
                    }
                    
                    columns.push({ data: 'dimensions' });
                    
                    if (priceTable.pricingMode === 'standard') {
                        columns.push(
                            { data: 'box_price', render: (data) => parseFloat(data).toFixed(2) },
                            { data: 'basic', render: (data) => parseFloat(data).toFixed(2), className: 'basic-group' },
                            { data: 'standard', render: (data) => parseFloat(data).toFixed(2), className: 'standard-group' },
                            { data: 'fragile', render: (data) => parseFloat(data).toFixed(2), className: 'fragile-group' },
                            { data: 'custom', render: (data) => parseFloat(data).toFixed(2), className: 'custom-group' }
                        );
                    } else {
                        // Itemized columns
                        columns.push(
                            { data: 'box_price', render: (data) => parseFloat(data).toFixed(2) },
                            { data: 'basic_materials', render: (data) => parseFloat(data).toFixed(2), className: 'basic-group' },
                            { data: 'basic_services', render: (data) => parseFloat(data).toFixed(2), className: 'basic-group' },
                            { data: 'basic_total', render: (data) => parseFloat(data).toFixed(2), className: 'total-cell basic-group' },
                            { data: 'standard_materials', render: (data) => parseFloat(data).toFixed(2), className: 'standard-group' },
                            { data: 'standard_services', render: (data) => parseFloat(data).toFixed(2), className: 'standard-group' },
                            { data: 'standard_total', render: (data) => parseFloat(data).toFixed(2), className: 'total-cell standard-group' },
                            { data: 'fragile_materials', render: (data) => parseFloat(data).toFixed(2), className: 'fragile-group' },
                            { data: 'fragile_services', render: (data) => parseFloat(data).toFixed(2), className: 'fragile-group' },
                            { data: 'fragile_total', render: (data) => parseFloat(data).toFixed(2), className: 'total-cell fragile-group' },
                            { data: 'custom_materials', render: (data) => parseFloat(data).toFixed(2), className: 'custom-group' },
                            { data: 'custom_services', render: (data) => parseFloat(data).toFixed(2), className: 'custom-group' },
                            { data: 'custom_total', render: (data) => parseFloat(data).toFixed(2), className: 'total-cell custom-group' }
                        );
                    }
                    
                    // Recreate DataTable with admin layout
                    priceTable.printDataTable = $table.DataTable({
                        data: window.printState.currentData,
                        columns: columns,
                        paging: false,
                        searching: false,
                        info: false,
                        ordering: false,
                        createdRow: (row, data, dataIndex) => {
                            const $row = $(row);
                            
                            // Add row coloring
                            if (data.section === 'CUBE') {
                                $row.addClass('blue-row');
                            } else if (data.section === 'SMALL') {
                                $row.addClass('yellow-row');
                            } else if (data.section === 'MEDIUM') {
                                $row.addClass('green-row');
                            } else if (data.section === 'LARGE') {
                                $row.addClass('pink-row');
                            } else if (data.section === 'SPECIALTY') {
                                $row.addClass('orange-row');
                            } else if (data.section === 'NORMAL') {
                                $row.addClass('normal-row');
                            } else if (data.section === 'CUSTOM') {
                                $row.addClass('custom-row');
                            }
                        }
                    });
                    
                    document.body.classList.add('printing');
                }
                } catch (error) {
                    console.error('Error preparing print view:', error);
                    // Continue with print even if there's an error
                }
            }
        });
        
        window.addEventListener('afterprint', function() {
            // Restore original table after printing
            if (priceTable && !priceTable.isEditable && window.printState) {
                try {
                    // Destroy print table
                    if (priceTable.printDataTable) {
                        priceTable.printDataTable.destroy();
                        delete priceTable.printDataTable;
                    }
                    
                    // Restore original view mode table
                    $('#priceTable').empty();
                    const tableHtml = priceTable.renderer.buildTableStructure(window.printState.currentData);
                    $('#priceTableContainer').html(tableHtml);
                    
                    // Reinitialize with view mode columns
                    const columns = priceTable.renderer.getColumnDefinitions(window.printState.currentData);
                    
                    priceTable.dataTable = $('#priceTable').DataTable({
                        data: window.printState.currentData,
                        columns: columns,
                        paging: true,
                        pageLength: 100,
                        searching: true,
                        info: false,
                        autoWidth: false,
                        order: [],
                        ordering: true,
                        drawCallback: (settings) => priceTable.onTableDraw(settings),
                        createdRow: (row, data, dataIndex) => priceTable.renderer.onRowCreated(row, data, dataIndex)
                    });
                    
                    // Restore event handlers
                    priceTable.renderer.setupEventHandlers();
                    
                    // Clean up
                    delete window.printState;
                    document.body.classList.remove('printing');
                    
                    // Restore filter label
                    $('.dataTables_filter label').contents().filter(function() {
                        return this.nodeType === 3;
                    }).first().replaceWith('Filter:');
                } catch (error) {
                    console.error('Error restoring view after print:', error);
                    // Reload page as fallback
                    window.location.reload();
                }
            } else if (priceTable && priceTable.dataTable) {
                // Admin mode - just restore pagination
                priceTable.dataTable.page.len(100).draw();
                document.body.classList.remove('printing');
            }
        });
        
        // Check authentication and load data
        async function initialize() {
            try {
                // Check authentication (don't require it for viewing)
                let authStatus = { isAuthenticated: false, authLevel: null };
                
                if (typeof AuthManager !== 'undefined') {
                    try {
                        authStatus = await AuthManager.getAuthStatus(storeId);
                    } catch (error) {
                        // Auth check failed, continue in read-only mode
                    }
                }
                
                // Get pricing mode
                const pricingMode = await window.api.fetchPricingMode(storeId);
                
                // Determine if editable
                const isEditable = authStatus.isAuthenticated && authStatus.authLevel === 'admin';
                
                // Update body class for CSS
                if (isEditable) {
                    document.body.classList.add('admin-authenticated');
                }
                
                // Update UI messages
                if (!isEditable) {
                    $('#editInstructions').hide();
                    $('#saveChanges').hide();
                }
                
                // Load box data
                const response = await window.api.fetchAllBoxes(storeId);
                
                const processedData = processBoxesData(response.boxes, pricingMode);
                
                // Create price table
                priceTable = new PriceTable('priceTableContainer', {
                    storeId: storeId,
                    isEditable: isEditable,
                    pricingMode: pricingMode,
                    onSave: saveChanges
                });
                
                await priceTable.initialize(processedData);
                
                // Check if floorplan exists for this store
                try {
                    const floorplanResponse = await fetch(`/api/store/${storeId}/floorplan`);
                    window.hasFloorplan = floorplanResponse.ok;
                } catch (error) {
                    console.error('Error checking floorplan:', error);
                    window.hasFloorplan = false;
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showStatus('Failed to initialize: ' + error.message, 'error');
            }
        }
        
        // Process boxes data into table format
        function processBoxesData(boxes, mode) {
            const result = [];
            
            for (const box of boxes) {
                const model = box.model || '';
                const dimensions = box.dimensions.join('x');
                const section = PriceTable.getBoxSection(model, box.type);
                
                let boxData;
                
                if (mode === 'standard') {
                    const prices = box.prices || [0, 0, 0, 0];
                    boxData = {
                        section: section,
                        model: model,
                        dimensions: dimensions,
                        box_price: prices[0],
                        basic: prices[0],
                        standard: prices[1],
                        fragile: prices[2],
                        custom: prices[3],
                        location: box.location || '???',
                        pricing_mode: 'standard'
                    };
                } else {
                    const ip = box['itemized-prices'] || {};
                    const boxPrice = ip['box-price'] || 0;
                    
                    boxData = {
                        section: section,
                        model: model,
                        dimensions: dimensions,
                        box_price: boxPrice,
                        basic_materials: ip['basic-materials'] || 0,
                        basic_services: ip['basic-services'] || 0,
                        basic_total: boxPrice + (ip['basic-materials'] || 0) + (ip['basic-services'] || 0),
                        standard_materials: ip['standard-materials'] || 0,
                        standard_services: ip['standard-services'] || 0,
                        standard_total: boxPrice + (ip['standard-materials'] || 0) + (ip['standard-services'] || 0),
                        fragile_materials: ip['fragile-materials'] || 0,
                        fragile_services: ip['fragile-services'] || 0,
                        fragile_total: boxPrice + (ip['fragile-materials'] || 0) + (ip['fragile-services'] || 0),
                        custom_materials: ip['custom-materials'] || 0,
                        custom_services: ip['custom-services'] || 0,
                        custom_total: boxPrice + (ip['custom-materials'] || 0) + (ip['custom-services'] || 0),
                        location: box.location || '???',
                        pricing_mode: 'itemized'
                    };
                }
                
                result.push(boxData);
            }
            
            // Define section order
            const sectionOrder = {
                'CUBE': 1,
                'SMALL': 2,
                'MEDIUM': 3,
                'LARGE': 4,
                'SPECIALTY': 5,
                'NORMAL': 6,
                'CUSTOM': 7,
                'OTHER': 8
            };
            
            // Sort by section order first, then by model name
            result.sort((a, b) => {
                const sectionCompare = (sectionOrder[a.section] || 999) - (sectionOrder[b.section] || 999);
                if (sectionCompare !== 0) {
                    return sectionCompare;
                }
                return a.model.localeCompare(b.model);
            });
            
            return result;
        }
        
        // Save changes handler
        async function saveChanges(changes) {
            showStatus('Saving changes...', 'loading');
            
            try {
                // Format changes for API
                const updates = {};
                for (const change of changes) {
                    if (!updates[change.model]) {
                        updates[change.model] = {};
                    }
                    updates[change.model][change.field] = change.newValue;
                }
                
                // Save via API
                await window.api.updateBoxPrices(storeId, updates);
                
                showStatus('Changes saved successfully!', 'success');
                
                // Show digest if available
                setTimeout(async () => {
                    try {
                        const digest = await window.api.getLastPriceDigest(storeId);
                        if (digest) {
                            showStatus(`Digest saved:\n${digest}`, 'success');
                        }
                    } catch (e) {
                        console.log('Could not fetch digest');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Failed to save changes: ' + error.message, 'error');
                throw error;
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const $status = $('#statusMessage');
            $status.removeClass('success error loading').addClass(type);
            
            const htmlMessage = message.replace(/\n/g, '<br>');
            $status.html(htmlMessage);
            $status.show();
            
            if (type !== 'loading') {
                setTimeout(() => {
                    $status.fadeOut();
                }, type === 'success' && message.includes('Digest saved') ? 10000 : 5000);
            }
        }
        
        // Save button handler
        $('#saveChanges').on('click', async () => {
            if (priceTable && priceTable.changeCount > 0) {
                try {
                    await priceTable.saveChanges();
                } catch (error) {
                    // Error already handled in saveChanges
                }
            }
        });
        
        // Initialize on page load
        $(document).ready(() => {
            initialize().catch(error => {
                console.error('Failed to initialize:', error);
                showStatus('Failed to load price table: ' + error.message, 'error');
            });
        });
    </script>
</body>
</html>