<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting Started - BoxChooser</title>
    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="icon" type="image/png" href="/assets/favicon.ico">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .getting-started-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .welcome-header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease-out;
        }
        
        .welcome-header h1 {
            font-size: 3em;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .welcome-header p {
            font-size: 1.3em;
            color: #666;
        }
        
        .progress-overview {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 40px;
            animation: fadeIn 1s ease-out 0.2s both;
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .setup-steps {
            display: grid;
            gap: 30px;
        }
        
        .step-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out both;
        }
        
        .step-card:nth-child(1) { animation-delay: 0.3s; }
        .step-card:nth-child(2) { animation-delay: 0.4s; }
        .step-card:nth-child(3) { animation-delay: 0.5s; }
        .step-card:nth-child(4) { animation-delay: 0.6s; }
        
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .step-number {
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .step-card.completed .step-number {
            background: #27ae60;
        }
        
        .step-card.optional .step-number {
            background: #95a5a6;
        }
        
        .step-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.4em;
        }
        
        .step-content p {
            color: #666;
            line-height: 1.6;
            margin: 0 0 15px 0;
        }
        
        .step-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .step-actions a {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .step-actions a:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .step-actions a.secondary {
            background: #ecf0f1;
            color: #34495e;
        }
        
        .step-actions a.secondary:hover {
            background: #bdc3c7;
        }
        
        .step-status {
            text-align: center;
        }
        
        .status-icon {
            font-size: 2em;
        }
        
        .status-icon.complete {
            color: #27ae60;
        }
        
        .status-icon.incomplete {
            color: #e74c3c;
        }
        
        .status-icon.partial {
            color: #f39c12;
        }
        
        .status-text {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        
        .completion-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 40px;
            text-align: center;
            animation: fadeIn 1s ease-out 0.7s both;
            display: none;
        }
        
        .completion-section.show {
            display: block;
        }
        
        .completion-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .completion-section button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .completion-section button:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .completion-section p {
            color: #666;
            margin-top: 10px;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <nav id="main-nav"></nav>
    
    <div class="getting-started-container">
        <div class="welcome-header">
            <h1>Welcome to BoxChooser! 🎉</h1>
            <p>Let's get your store set up in just a few steps</p>
        </div>
        
        <div class="progress-overview">
            <h2>Your Progress</h2>
            <div class="progress-stats" id="progress-stats">
                <div class="loading">Loading store status</div>
            </div>
        </div>
        
        <div class="setup-steps" id="setup-steps">
            <div class="loading">Preparing setup guide</div>
        </div>
        
        <div class="completion-section" id="completion-section">
            <h3>Take off the training wheels!</h3>
            <button onclick="completeSetup()">Don't show this guide again</button>
        </div>
    </div>
    
    <script src="/js/lib/auth.js"></script>
    <script src="/js/lib/api-utils.js"></script>
    <script type="module" src="/js/components/navigation.js"></script>
    <script src="/js/components/help-bubble.js"></script>
    <script type="module">
        // API utils and AuthManager are available as globals
        const { apiUtils, AuthManager } = window;
        
        let storeId = null;
        
        async function init() {
            try {
                // Get store ID using the standard method
                storeId = AuthManager.getCurrentStoreId();
                if (!storeId) {
                    window.location.href = '/login';
                    return;
                }
                
                // Require admin auth
                await AuthManager.requireAuth(storeId, true);
                
                // Load store status
                await loadStoreStatus();
                
            } catch (error) {
                console.error('Initialization failed:', error);
                alert('Failed to load getting started guide');
            }
        }
        
        async function loadStoreStatus() {
            try {
                // Get store statistics
                const response = await apiUtils.authenticatedFetch(`/api/store/${storeId}/stats`, storeId);
                if (!response.ok) {
                    throw new Error('Failed to load store statistics');
                }
                
                const stats = await response.json();
                
                // Update progress stats
                updateProgressStats(stats);
                
                // Update setup steps
                updateSetupSteps(stats);
                
                // Check if we can enable completion
                checkCompletion(stats);
                
            } catch (error) {
                console.error('Failed to load store status:', error);
                document.getElementById('progress-stats').innerHTML = 
                    '<div class="error">Failed to load store status</div>';
            }
        }
        
        function updateProgressStats(stats) {
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_boxes || 0}</div>
                    <div class="stat-label">Boxes Added</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.boxes_with_prices || 0}</div>
                    <div class="stat-label">Boxes with Prices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.has_floorplan ? 'Yes' : 'No'}</div>
                    <div class="stat-label">Floorplan Uploaded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.located_boxes || 0}</div>
                    <div class="stat-label">Boxes Located</div>
                </div>
            `;
            
            document.getElementById('progress-stats').innerHTML = statsHtml;
        }
        
        function updateSetupSteps(stats) {
            const steps = [
                {
                    number: 1,
                    title: 'Add Boxes to Your Inventory',
                    description: 'Import boxes from an Excel price sheet or add them manually. You need at least one box to get started.',
                    status: stats.total_boxes > 0 ? 'complete' : 'incomplete',
                    statusText: stats.total_boxes > 0 ? `${stats.total_boxes} boxes added` : 'No boxes yet',
                    actions: [
                        { text: 'Import from Excel (Recommended)', href: `/${storeId}/import`, primary: true },
                        { text: 'Add Manually', href: `/${storeId}/boxes`, primary: false }
                    ]
                },
                {
                    number: 2,
                    title: 'Set Box Prices',
                    description: 'Import prices from Excel or set them manually. Each box needs at least one price to be available for selection.',
                    status: stats.boxes_with_prices > 0 ? (stats.boxes_with_prices === stats.total_boxes ? 'complete' : 'partial') : 'incomplete',
                    statusText: `${stats.boxes_with_prices} of ${stats.total_boxes} boxes have prices`,
                    actions: [
                        { text: 'Import Prices', href: `/${storeId}/import`, primary: true },
                        { text: 'Edit Prices', href: `/${storeId}/prices`, primary: false }
                    ]
                },
                {
                    number: 3,
                    title: 'Upload Store Floorplan (Optional)',
                    description: 'Upload a floorplan image and place boxes on it for easy visual location reference during packing.',
                    status: stats.has_floorplan ? (stats.located_boxes > 0 ? 'complete' : 'partial') : 'incomplete',
                    statusText: stats.has_floorplan ? 
                        (stats.located_boxes > 0 ? `${stats.located_boxes} boxes located` : 'Floorplan uploaded, no boxes located') : 
                        'No floorplan uploaded',
                    actions: [
                        { text: 'Manage Floorplan', href: `/${storeId}/floorplan`, primary: true }
                    ],
                    optional: true
                },
                {
                    number: 4,
                    title: 'Customize Packing Rules (Optional)',
                    description: 'Fine-tune how BoxChooser recommends boxes by adjusting padding requirements and optimization preferences.',
                    status: 'optional',
                    statusText: 'Using default settings',
                    actions: [
                        { text: 'View Settings', href: `/${storeId}/settings`, primary: true }
                    ],
                    optional: true
                }
            ];
            
            const stepsHtml = steps.map(step => {
                const statusIcon = step.status === 'complete' ? '✓' : 
                                 step.status === 'partial' ? '◐' : 
                                 step.status === 'optional' ? '○' : '✗';
                const statusClass = step.status === 'complete' ? 'complete' : 
                                  step.status === 'partial' ? 'partial' : 'incomplete';
                
                return `
                    <div class="step-card ${step.status === 'complete' ? 'completed' : ''} ${step.optional ? 'optional' : ''}">
                        <div class="step-number">${step.number}</div>
                        <div class="step-content">
                            <h3>${step.title}</h3>
                            <p>${step.description}</p>
                            <div class="step-actions">
                                ${step.actions.map(action => 
                                    `<a href="${action.href}" class="${action.primary ? '' : 'secondary'}">${action.text}</a>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="step-status">
                            <div class="status-icon ${statusClass}">${statusIcon}</div>
                            <div class="status-text">${step.statusText}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('setup-steps').innerHTML = stepsHtml;
        }
        
        function checkCompletion(stats) {
            // Show completion if at least 1 box with 1 price
            if (stats.boxes_with_prices > 0) {
                document.getElementById('completion-section').classList.add('show');
            }
        }
        
        window.completeSetup = async function() {
            if (!confirm('Are you sure you want to hide this getting started guide?')) {
                return;
            }
            
            try {
                const response = await apiUtils.authenticatedFetch(`/api/store/${storeId}/complete-setup`, storeId, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to complete setup');
                }
                
                // Redirect to main page
                window.location.href = '/';
                
            } catch (error) {
                console.error('Failed to complete setup:', error);
                alert('Failed to save your preference. Please try again.');
            }
        };
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>